<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="https://public-frontend-cos.metadl.com/mgx/img/favicon.png" type="image/png">
    <title>Troca de Senha - SaaS Agendamento</title>
    <link rel="stylesheet" href="/frontend/assets/styles.css">
</head>

<body>
    <!-- Header -->
    <header class="header">
        <div class="container">
            <nav class="nav">
                <a href="/" class="logo">✨ Aluvi Agendamentos</a>
            </nav>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container">
        <div style="max-width: 400px; margin: 2rem auto;">

            <div class="card mb-3 fade-in">
                <div class="card-header text-center">
                    <h1 class="card-title">Troca de Senha Obrigatória</h1>
                    <p class="text-muted">Esta é sua primeira vez fazendo login. Por segurança, você deve alterar sua senha temporária.</p>
                </div>

                <form id="changePasswordForm">
                    <div class="form-group">
                        <label for="currentPassword" class="form-label">Senha Atual (Temporária)</label>
                        <input type="password" id="currentPassword" class="form-control" required>
                    </div>

                    <div class="form-group">
                        <label for="newPassword" class="form-label">Nova Senha</label>
                        <input type="password" id="newPassword" class="form-control" required minlength="6">
                        <small class="text-muted">Mínimo 6 caracteres</small>
                    </div>

                    <div class="form-group">
                        <label for="confirmPassword" class="form-label">Confirmar Nova Senha</label>
                        <input type="password" id="confirmPassword" class="form-control" required minlength="6">
                    </div>

                    <button type="submit" class="btn btn-primary" style="width: 100%;">
                        Alterar Senha
                    </button>
                </form>

                <div class="text-center mt-2">
                    <button class="btn btn-link" id="logoutBtn">Sair e fazer login depois</button>
                </div>
            </div>
        </div>
    </main>

    <!-- Scripts -->
    <script src="/frontend/config.js"></script>
    <script src="/frontend/app.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Verificar se deve forçar troca de senha
            const forceChange = sessionStorage.getItem('forcePasswordChange');
            if (!forceChange) {
                // Se não deve forçar, redirecionar para login
                window.location.href = 'login.html';
                return;
            }

            setupEventListeners();
        });

        function setupEventListeners() {
            // Submit do formulário
            document.getElementById('changePasswordForm').addEventListener('submit', handlePasswordChange);

            // Botão de logout
            document.getElementById('logoutBtn').addEventListener('click', () => {
                sessionStorage.removeItem('forcePasswordChange');
                api.logout();
            });
        }

        async function handlePasswordChange(event) {
            event.preventDefault();

            UI.clearAlerts();

            const currentPassword = document.getElementById('currentPassword').value.trim();
            const newPassword = document.getElementById('newPassword').value.trim();
            const confirmPassword = document.getElementById('confirmPassword').value.trim();

            // Validações
            if (!currentPassword) {
                UI.showError('Por favor, informe sua senha atual.');
                document.getElementById('currentPassword').focus();
                return;
            }

            if (!newPassword) {
                UI.showError('Por favor, informe sua nova senha.');
                document.getElementById('newPassword').focus();
                return;
            }

            if (newPassword.length < 6) {
                UI.showError('A nova senha deve ter pelo menos 6 caracteres.');
                document.getElementById('newPassword').focus();
                return;
            }

            if (newPassword !== confirmPassword) {
                UI.showError('A confirmação da senha não corresponde.');
                document.getElementById('confirmPassword').focus();
                return;
            }

            if (currentPassword === newPassword) {
                UI.showError('A nova senha deve ser diferente da atual.');
                document.getElementById('newPassword').focus();
                return;
            }

            try {
                // Desabilitar botão durante a mudança
                const submitBtn = event.target.querySelector('button[type="submit"]');
                const originalText = submitBtn.textContent;
                submitBtn.textContent = 'Alterando...';
                submitBtn.disabled = true;

                console.log('[CHANGE_PASSWORD] Enviando solicitação de troca de senha...');

                const response = await api.request('/auth/change-password', {
                    method: 'POST',
                    body: JSON.stringify({
                        senha_atual: currentPassword,
                        nova_senha: newPassword
                    })
                });

                console.log('[CHANGE_PASSWORD] Resposta:', response);

                if (response.success) {
                    UI.showSuccess('Senha alterada com sucesso! Redirecionando...');

                    // Limpar flag de força de troca
                    sessionStorage.removeItem('forcePasswordChange');

                    // Redirecionar para dashboard após 2 segundos
                    setTimeout(() => {
                        window.location.href = 'dashboard-dono.html';
                    }, 2000);
                } else {
                    throw new Error(response.message || 'Erro ao alterar senha');
                }

            } catch (error) {
                console.error('[CHANGE_PASSWORD] Erro:', error);

                let errorMessage = 'Erro ao alterar senha. Tente novamente.';

                if (error.message) {
                    if (error.message.includes('atual incorreta')) {
                        errorMessage = 'Senha atual incorreta. Verifique e tente novamente.';
                    } else if (error.message.includes('422') || error.message.includes('Unprocessable Entity')) {
                        errorMessage = 'Dados inválidos. Verifique se todos os campos estão preenchidos corretamente.';
                    } else if (error.message.includes('401')) {
                        errorMessage = 'Sessão expirada. Faça login novamente.';
                        sessionStorage.removeItem('forcePasswordChange');
                        setTimeout(() => window.location.href = 'login.html', 2000);
                        return;
                    } else {
                        errorMessage = error.message;
                    }
                }

                UI.showError(errorMessage);

                // Reabilitar botão
                const submitBtn = event.target.querySelector('button[type="submit"]');
                submitBtn.textContent = 'Alterar Senha';
                submitBtn.disabled = false;
            }
        }
    </script>
</body>

</html>