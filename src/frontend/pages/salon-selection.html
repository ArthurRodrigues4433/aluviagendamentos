<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="https://public-frontend-cos.metadl.com/mgx/img/favicon.png" type="image/png">
    <title>Selecionar Sal√£o - SaaS Agendamento</title>
    <link rel="stylesheet" href="/frontend/assets/styles.css">
</head>

<body>
    <!-- Header -->
    <header class="header">
        <div class="container">
            <nav class="nav">
                <a href="/" class="logo">‚ú® Aluvi Agendamentos</a>
                <ul class="nav-links">
                    <li><a href="/">In√≠cio</a></li>
                    <li><a href="/login.html">Login</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container">
        <div style="max-width: 800px; margin: 2rem auto;">

            <!-- T√≠tulo e descri√ß√£o -->
            <div class="card mb-3 fade-in">
                <div class="text-center">
                    <h1>Escolha seu Sal√£o</h1>
                    <p class="text-muted">Selecione o sal√£o onde deseja agendar seus servi√ßos</p>
                </div>
            </div>

            <!-- Campo de pesquisa -->
            <div class="card mb-3 fade-in">
                <div class="form-group">
                    <label class="form-label">Buscar Sal√£o</label>
                    <input type="text" id="salonSearch" class="form-control" placeholder="Digite o nome do sal√£o..." onkeyup="filterSalons()">
                    <small class="text-muted">Digite para filtrar os sal√µes dispon√≠veis</small>
                </div>
            </div>

            <!-- Mensagens de erro -->
            <div id="errorMessages" style="display: none;"></div>

            <!-- Loading -->
            <div id="loadingSalons" class="card">
                <div class="text-center" style="padding: 2rem;">
                    <div class="loading">Carregando sal√µes dispon√≠veis...</div>
                </div>
            </div>

            <!-- Lista de Sal√µes -->
            <div id="salonsList" style="display: none;">
                <div class="grid grid-1" id="salonsGrid">
                    <!-- Sal√µes ser√£o inseridos aqui dinamicamente -->
                </div>
            </div>

            <!-- Nenhum sal√£o dispon√≠vel -->
            <div id="noSalons" class="card" style="display: none;">
                <div class="text-center" style="padding: 2rem;">
                    <h3>Nenhum sal√£o dispon√≠vel</h3>
                    <p class="text-muted">No momento n√£o h√° sal√µes dispon√≠veis para agendamento.</p>
                    <p class="text-muted">Tente novamente mais tarde ou entre em contato conosco.</p>
                    <button class="btn btn-outline" onclick="window.location.href='/'" style="margin-top: 1rem;">
                        Voltar ao In√≠cio
                    </button>
                </div>
            </div>

        </div>
    </main>

    <!-- Scripts -->
    <script src="/frontend/config.js"></script>
    <script src="/frontend/app.js"></script>
    <script>
        // Vari√°vel global para armazenar todos os sal√µes
        let allSalons = [];
        let lastSalonData = null; // Para detectar mudan√ßas
        let pollingInterval = null; // Para polling de atualiza√ß√µes

        // Verifica√ß√£o de autentica√ß√£o
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('[SALON-SELECTION] Inicializando p√°gina de sele√ß√£o de sal√£o...');

            // Verificar se usu√°rio est√° autenticado
            if (!TokenManager.isValid()) {
                console.warn('[SALON-SELECTION] Usu√°rio n√£o autenticado, redirecionando para login');
                window.location.href = 'login.html';
                return;
            }

            // Verificar se veio de um link espec√≠fico com salon_id
            const urlSalonId = SalonManager.getSalonIdFromURL();
            if (urlSalonId) {
                console.log(`[SALON-SELECTION] Vindo de link espec√≠fico, definindo sal√£o ${urlSalonId} e redirecionando...`);
                try {
                    await SalonManager.switchSalon(parseInt(urlSalonId));
                    window.location.href = 'dashboard-cliente.html';
                    return;
                } catch (error) {
                    console.error('[SALON-SELECTION] Erro ao definir sal√£o do link:', error);
                    UI.showError('Erro ao acessar o sal√£o solicitado.');
                }
            }

            // Sempre mostrar sele√ß√£o de sal√µes para clientes (n√£o pular se tem sal√£o ativo)
            console.log('[SALON-SELECTION] Mostrando sele√ß√£o de sal√µes...');

            // Carregar sal√µes dispon√≠veis
            await loadAvailableSalons();
        });

        // Limpar polling quando a p√°gina for fechada
        window.addEventListener('beforeunload', function() {
            console.log('[SALON-SELECTION] P√°gina sendo fechada, parando polling...');
            stopRealtimePolling();
        });

        // Carregar lista de sal√µes dispon√≠veis
        async function loadAvailableSalons() {
            try {
                console.log('[SALON-SELECTION] Carregando sal√µes dispon√≠veis...');
                console.log('[SALON-SELECTION] Timestamp:', new Date().toISOString());

                const salons = await SalonManager.loadAvailableSalons();
                console.log('[SALON-SELECTION] Sal√µes recebidos da API:', salons);
                console.log('[SALON-SELECTION] N√∫mero de sal√µes:', salons ? salons.length : 0);

                if (!salons || salons.length === 0) {
                    console.log('[SALON-SELECTION] Nenhum sal√£o encontrado, mostrando mensagem');
                    showNoSalons();
                    return;
                }

                // Verificar se os dados dos sal√µes mudaram (usando campos customizados)
                const currentSalonData = JSON.stringify(salons.map(s => ({
                    id: s.id,
                    cardDisplayName: s.cardDisplayName,
                    cardLocation: s.cardLocation,
                    cardDescription: s.cardDescription,
                    cardLogo: s.cardLogo
                })));
                console.log('[SALON-SELECTION] Dados atuais dos sal√µes (campos customizados):', currentSalonData);

                // Armazenar todos os sal√µes para filtragem
                allSalons = salons;

                displaySalons(salons);

                // Iniciar polling para detectar mudan√ßas em tempo real
                startRealtimePolling();

            } catch (error) {
                console.error('[SALON-SELECTION] Erro ao carregar sal√µes:', error);
                console.error('[SALON-SELECTION] Detalhes do erro:', {
                    message: error.message,
                    stack: error.stack,
                    timestamp: new Date().toISOString()
                });
                showError('Erro ao carregar sal√µes dispon√≠veis. Tente recarregar a p√°gina.');
            }
        }

        // Verificar se os dados dos sal√µes mudaram
        async function checkForSalonUpdates() {
            try {
                console.log('[SALON-SELECTION] Verificando atualiza√ß√µes nos dados dos sal√µes...');

                const salons = await SalonManager.loadAvailableSalons();
                if (!salons) return;

                const currentSalonData = JSON.stringify(salons.map(s => ({
                    id: s.id,
                    cardDisplayName: s.cardDisplayName,
                    cardLocation: s.cardLocation,
                    cardDescription: s.cardDescription,
                    cardLogo: s.cardLogo
                })));

                if (lastSalonData && lastSalonData !== currentSalonData) {
                    console.log('[SALON-SELECTION] üîÑ DETECTADA MUDAN√áA NOS DADOS DOS SAL√ïES!');
                    console.log('[SALON-SELECTION] Dados anteriores:', lastSalonData);
                    console.log('[SALON-SELECTION] Dados atuais:', currentSalonData);

                    // Atualizar dados e re-renderizar
                    allSalons = salons;
                    lastSalonData = currentSalonData;
                    displaySalons(salons);

                    console.log('[SALON-SELECTION] ‚úÖ Cards atualizados automaticamente');
                } else if (!lastSalonData) {
                    // Primeira vez, apenas armazenar
                    lastSalonData = currentSalonData;
                    console.log('[SALON-SELECTION] Dados iniciais armazenados para compara√ß√£o');
                } else {
                    console.log('[SALON-SELECTION] Nenhum mudan√ßa detectada nos dados dos sal√µes');
                }

            } catch (error) {
                console.error('[SALON-SELECTION] Erro ao verificar atualiza√ß√µes:', error);
            }
        }

        // Iniciar polling para atualiza√ß√µes em tempo real
        function startRealtimePolling() {
            console.log('[SALON-SELECTION] Iniciando polling para atualiza√ß√µes em tempo real...');

            // Verificar a cada 30 segundos
            pollingInterval = setInterval(checkForSalonUpdates, 30000);

            console.log('[SALON-SELECTION] Polling iniciado - verificando a cada 30 segundos');
        }

        // Parar polling
        function stopRealtimePolling() {
            if (pollingInterval) {
                clearInterval(pollingInterval);
                pollingInterval = null;
                console.log('[SALON-SELECTION] Polling parado');
            }
        }

        // Exibir lista de sal√µes
        function displaySalons(salons) {
            console.log('[SALON-SELECTION] Renderizando cards de sal√µes...');
            console.log('[SALON-SELECTION] N√∫mero de sal√µes a renderizar:', salons.length);

            const salonsGrid = document.getElementById('salonsGrid');

            // Limpar conte√∫do anterior
            const previousCount = salonsGrid.children.length;
            console.log('[SALON-SELECTION] Limpando grid anterior com', previousCount, 'elementos');
            salonsGrid.innerHTML = '';

            // Criar cards para cada sal√£o
            salons.forEach((salon, index) => {
                console.log(`[SALON-SELECTION] Criando card ${index + 1}/${salons.length} para sal√£o:`, salon.nome);
                const salonCard = createSalonCard(salon);
                salonsGrid.appendChild(salonCard);
            });

            // Mostrar lista e esconder loading
            document.getElementById('loadingSalons').style.display = 'none';
            document.getElementById('salonsList').style.display = 'block';

            console.log('[SALON-SELECTION] Cards renderizados com sucesso. Total de cards:', salonsGrid.children.length);
            console.log('[SALON-SELECTION] Timestamp da renderiza√ß√£o:', new Date().toISOString());
        }

        // Criar card do sal√£o
        function createSalonCard(salon) {
            console.log('[SALON-SELECTION] Criando card para sal√£o:', salon);
            console.log('[SALON-SELECTION] ID do sal√£o:', salon.id);

            const card = document.createElement('div');
            card.className = 'card salon-card fade-in';
            card.onclick = () => selectSalon(salon.id);

            // Usar apenas campos da apar√™ncia customizada (subaba "apar√™ncia do card")
            // Estes campos v√™m da configura√ß√£o espec√≠fica do dono, n√£o dos campos gerais da empresa
            const displayName = salon.cardDisplayName || salon.nome || 'Nome n√£o definido';
            const displayLocation = salon.cardLocation || salon.endereco || 'Localiza√ß√£o n√£o definida';
            const displayDescription = salon.cardDescription || salon.descricao || '';
            const displayLogo = salon.cardLogo || salon.logo;

            // Log dos campos customizados que ser√£o usados no card
            console.log(`[SALON-SELECTION] Campos customizados para sal√£o ${salon.id}:`, {
                displayName,
                displayLocation,
                displayDescription,
                displayLogo,
                timestamp: new Date().toISOString()
            });

            // Verificar se os campos mudaram desde a √∫ltima renderiza√ß√£o
            const cardData = {
                displayName,
                displayLocation,
                displayDescription,
                displayLogo
            };
            console.log(`[SALON-SELECTION] Dados que ser√£o renderizados no card ${salon.id}:`, cardData);

            card.innerHTML = `
                <div class="salon-card-content">
                    <div class="salon-header">
                        ${displayLogo ? `<img src="${displayLogo}" alt="Logo ${displayName}" class="salon-logo" onerror="console.log('[SALON-SELECTION] Erro ao carregar logo para sal√£o ${salon.id}')">` : '<div class="salon-logo-placeholder">üè™</div>'}
                        <div class="salon-info">
                            <h3 class="salon-name">${displayName}</h3>
                            <p class="salon-address">${displayLocation}</p>
                        </div>
                    </div>
                    <div class="salon-details">
                        ${displayDescription ? `<p class="salon-description">${displayDescription}</p>` : ''}
                        <div class="salon-actions">
                            <button class="btn btn-primary" onclick="event.stopPropagation(); selectSalon(${salon.id})">
                                Selecionar Este Sal√£o
                            </button>
                        </div>
                    </div>
                </div>
            `;

            console.log(`[SALON-SELECTION] Card criado para sal√£o ${salon.id} com nome customizado: ${displayName}`);
            return card;
        }

        // Selecionar sal√£o
        async function selectSalon(salonId) {
            try {
                console.log(`[SALON-SELECTION] Selecionando sal√£o ${salonId}...`);

                // Mostrar loading
                UI.showInfo('Configurando sal√£o...');

                // Definir sal√£o ativo
                await SalonManager.switchSalon(salonId);

                // Redirecionar para dashboard
                console.log('[SALON-SELECTION] Sal√£o selecionado com sucesso, redirecionando...');
                window.location.href = 'dashboard-cliente.html';

            } catch (error) {
                console.error('[SALON-SELECTION] Erro ao selecionar sal√£o:', error);
                UI.showError('Erro ao selecionar sal√£o. Tente novamente.');
            }
        }

        // Mostrar mensagem de nenhum sal√£o dispon√≠vel
        function showNoSalons() {
            document.getElementById('loadingSalons').style.display = 'none';
            document.getElementById('noSalons').style.display = 'block';
        }

        // Mostrar erro
        function showError(message) {
            document.getElementById('loadingSalons').style.display = 'none';
            const errorDiv = document.getElementById('errorMessages');
            errorDiv.style.display = 'block';
            errorDiv.innerHTML = `
                <div class="alert alert-error" style="margin-bottom: 1rem;">
                    <strong>Erro</strong><br>
                    ${message}
                </div>
            `;
        }

        // Filtrar sal√µes por nome
        function filterSalons() {
            const searchTerm = document.getElementById('salonSearch').value.toLowerCase().trim();

            if (!searchTerm) {
                // Se n√£o h√° termo de busca, mostrar todos os sal√µes
                displaySalons(allSalons);
                return;
            }

            // Filtrar sal√µes que contenham o termo de busca no nome
            const filteredSalons = allSalons.filter(salon =>
                salon.nome && salon.nome.toLowerCase().includes(searchTerm)
            );

            // Mostrar sal√µes filtrados
            displaySalons(filteredSalons);

            // Se n√£o encontrou nenhum sal√£o, mostrar mensagem
            if (filteredSalons.length === 0) {
                const salonsGrid = document.getElementById('salonsGrid');
                salonsGrid.innerHTML = `
                    <div class="card" style="text-align: center; padding: 2rem;">
                        <h3>Nenhum sal√£o encontrado</h3>
                        <p class="text-muted">N√£o foi encontrado nenhum sal√£o com o nome "${searchTerm}".</p>
                        <button class="btn btn-outline" onclick="document.getElementById('salonSearch').value=''; filterSalons();">
                            Mostrar todos os sal√µes
                        </button>
                    </div>
                `;
            }
        }
    </script>

    <style>
        .salon-card {
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 1rem;
        }

        .salon-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .salon-card-content {
            padding: 1.5rem;
        }

        .salon-header {
            display: flex;
            align-items: center;
            margin-bottom: 1rem;
        }

        .salon-logo {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 8px;
            margin-right: 1rem;
        }

        .salon-logo-placeholder {
            width: 60px;
            height: 60px;
            background: #f8f9fa;
            border: 2px dashed #dee2e6;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            margin-right: 1rem;
        }

        .salon-info {
            flex: 1;
        }

        .salon-name {
            margin: 0 0 0.5rem 0;
            color: #333;
        }

        .salon-address {
            margin: 0;
            color: #666;
            font-size: 0.9rem;
        }

        .salon-phone {
            margin: 0 0 1rem 0;
            color: #666;
            font-size: 0.9rem;
        }

        .salon-actions {
            text-align: right;
        }

        @media (max-width: 768px) {
            .salon-header {
                flex-direction: column;
                text-align: center;
            }

            .salon-logo, .salon-logo-placeholder {
                margin-right: 0;
                margin-bottom: 1rem;
            }

            .salon-actions {
                text-align: center;
                margin-top: 1rem;
            }
        }
    </style>
</body>

</html>