<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="https://public-frontend-cos.metadl.com/mgx/img/favicon.png" type="image/png">
    <title>Dashboard Dono - SaaS Agendamento</title>
    <link rel="stylesheet" href="/frontend/assets/styles.css">
</head>

<body>
    <!-- Header -->
    <header class="header">
        <div class="container">
            <nav class="nav">
                <div class="logo-section" style="display: flex; align-items: center;">
                    <img id="salonLogo" src="" alt="" style="height: 40px; margin-right: 10px; display: none; max-width: 40px; object-fit: contain;">
                    <div style="display: flex; flex-direction: column;">
                        <a href="dashboard-dono.html" class="logo" id="salonName">Aluvi</a>
                        <small id="salonSubtitle" style="color: #666; font-size: 0.75rem;">Sistema de Agendamentos</small>
                    </div>
                </div>
                <ul class="nav-links">
                    <li><span id="welcomeMessage">Carregando...</span></li>
                    <li><a href="#" id="switchSalonBtn" style="display: none;">Trocar Salão</a></li>
                    <li><a href="#" id="logoutBtn">Sair</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container">
        <!-- Navigation Tabs -->
        <div class="card mb-3">
            <div class="d-flex gap-1" style="flex-wrap: wrap;">
                <button class="btn btn-primary tab-btn active" data-tab="dashboard">Dashboard</button>
                <button class="btn btn-outline tab-btn" data-tab="appointments">Agendamentos</button>
                <button class="btn btn-outline tab-btn" data-tab="clients">Clientes</button>
                <button class="btn btn-outline tab-btn" data-tab="services">Serviços</button>
                <button class="btn btn-outline tab-btn" data-tab="professionals">Profissionais</button>
                <button class="btn btn-outline tab-btn" data-tab="business-hours">Horários</button>
                <button class="btn btn-outline tab-btn" data-tab="company-profile">Empresa</button>
                <button class="btn btn-outline tab-btn" data-tab="reports">Relatórios</button>
            </div>
        </div>

        <!-- Dashboard Tab -->
        <div id="dashboardTab" class="tab-content active">
            <!-- Status da Mensalidade -->
            <div id="subscriptionStatus" class="card mb-3" style="display: none;">
                <div class="alert alert-warning">
                    <h4>⚠️ Atenção: Mensalidade Pendente</h4>
                    <p>Sua mensalidade está em atraso. Algumas funcionalidades estão bloqueadas até a regularização do pagamento.</p>
                    <div id="subscriptionDetails"></div>
                </div>
            </div>

            <h2 class="mb-2">Estatísticas Gerais</h2>

            <div id="statsGrid" class="stats-grid">
                <div class="loading">Carregando estatísticas...</div>
            </div>

            <!-- Agendamentos Hoje -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Agendamentos Hoje</h3>
                </div>
                <div id="todayAppointments">
                    <div class="loading">Carregando agendamentos...</div>
                </div>
            </div>

            <!-- Agendamentos Recentes -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Agendamentos Recentes</h3>
                </div>
                <div id="recentAppointments">
                    <div class="loading">Carregando agendamentos...</div>
                </div>
            </div>
        </div>

        <!-- Appointments Tab -->
        <div id="appointmentsTab" class="tab-content">
            <!-- Sub-tabs for Appointments -->
            <div class="card mb-3">
                <div class="d-flex gap-1" style="flex-wrap: wrap;">
                    <button class="btn btn-primary sub-tab-btn active" data-sub-tab="manage">Gerenciar Agendamentos</button>
                    <button class="btn btn-outline sub-tab-btn" data-sub-tab="history">Histórico de Agendamentos</button>
                </div>
            </div>

            <!-- Manage Appointments Sub-tab -->
            <div id="manageAppointmentsSubTab" class="sub-tab-content active">
                <div class="d-flex justify-between align-center mb-2">
                    <h2>Gerenciar Agendamentos</h2>
                    <button class="btn btn-success" id="refreshAppointmentsBtn">Atualizar</button>
                </div>

                <div class="card">
                    <div id="appointmentsList">
                        <div class="loading">Carregando agendamentos...</div>
                    </div>
                </div>
            </div>

            <!-- History Appointments Sub-tab -->
            <div id="historyAppointmentsSubTab" class="sub-tab-content">
                <div class="d-flex justify-between align-center mb-2">
                    <h2>Histórico de Agendamentos</h2>
                    <button class="btn btn-success" id="refreshHistoryBtn">Atualizar</button>
                </div>

                <!-- Filters -->
                <div class="card mb-3">
                    <div class="form-group">
                        <label class="form-label">Filtros</label>
                        <div class="grid grid-4">
                            <div>
                                <label>Status</label>
                                <select id="historyStatusFilter" class="form-control form-select">
                                    <option value="">Todos os Status</option>
                                    <option value="agendado">Agendado</option>
                                    <option value="confirmado">Confirmado</option>
                                    <option value="concluido">Concluído</option>
                                    <option value="cancelado">Cancelado</option>
                                    <option value="nao_compareceu">Não Compareceu</option>
                                </select>
                            </div>
                            <div>
                                <label>Data Inicial</label>
                                <input type="date" id="historyDateFrom" class="form-control">
                            </div>
                            <div>
                                <label>Data Final</label>
                                <input type="date" id="historyDateTo" class="form-control">
                            </div>
                            <div>
                                <label>Cliente</label>
                                <input type="text" id="historyClientFilter" class="form-control" placeholder="Nome do cliente">
                            </div>
                        </div>
                        <div class="d-flex gap-1 mt-2">
                            <button class="btn btn-primary" id="applyHistoryFilters">Aplicar Filtros</button>
                            <button class="btn btn-secondary" id="clearHistoryFilters">Limpar Filtros</button>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div id="appointmentsHistoryList">
                        <div class="loading">Carregando histórico...</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Clients Tab -->
        <div id="clientsTab" class="tab-content">
            <div class="d-flex justify-between align-center mb-2">
                <h2>Gerenciar Clientes</h2>
                <button class="btn btn-primary" id="addClientBtn">Adicionar Cliente</button>
            </div>

            <div class="card">
                <div id="clientsList">
                    <div class="loading">Carregando clientes...</div>
                </div>
            </div>
        </div>

        <!-- Services Tab -->
        <div id="servicesTab" class="tab-content">
            <div class="d-flex justify-between align-center mb-2">
                <h2>Gerenciar Serviços</h2>
                <button class="btn btn-primary" id="addServiceBtn">Adicionar Serviço</button>
            </div>

            <div class="card">
                <div id="servicesList">
                    <div class="loading">Carregando serviços...</div>
                </div>
            </div>
        </div>

        <!-- Professionals Tab -->
        <div id="professionalsTab" class="tab-content">
            <div class="d-flex justify-between align-center mb-2">
                <h2>Gerenciar Profissionais</h2>
                <button class="btn btn-primary" id="addProfessionalBtn">Adicionar Profissional</button>
            </div>

            <!-- Sub-tabs for Professionals -->
            <div class="card mb-3">
                <div class="d-flex gap-1" style="flex-wrap: wrap;">
                    <button class="btn btn-primary sub-tab-btn active" data-sub-tab="manage">Gerenciar Profissionais</button>
                    <button class="btn btn-outline sub-tab-btn" data-sub-tab="services">Associar Serviços</button>
                </div>
            </div>

            <!-- Manage Professionals Sub-tab -->
            <div id="manageProfessionalsSubTab" class="sub-tab-content active">
                <div class="card">
                    <div id="professionalsList">
                        <div class="loading">Carregando profissionais...</div>
                    </div>
                </div>
            </div>

            <!-- Associate Services Sub-tab -->
            <div id="associateServicesSubTab" class="sub-tab-content">
                <div class="card">
                    <h3 class="mb-2">Associar Serviços aos Profissionais</h3>
                    <p class="text-muted mb-3">Selecione um profissional e os serviços que ele pode realizar:</p>

                    <div class="form-group">
                        <label class="form-label">Selecionar Profissional</label>
                        <select id="professionalSelect" class="form-control form-select">
                            <option value="">Selecione um profissional...</option>
                        </select>
                    </div>

                    <div id="servicesAssociation" class="mt-3" style="display: none;">
                        <h4>Serviços Disponíveis</h4>
                        <div class="d-flex gap-1 mb-2">
                            <button class="btn btn-outline btn-sm" id="selectAllServices">Marcar Todos</button>
                        </div>
                        <div id="servicesCheckboxes" class="grid grid-2 mt-2">
                            <!-- Checkboxes serão inseridos dinamicamente -->
                        </div>
                        <div class="d-flex gap-1 mt-3">
                            <button class="btn btn-primary" id="saveServiceAssociation">Salvar Associação</button>
                            <button class="btn btn-secondary" id="cancelServiceAssociation">Cancelar</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Business Hours Tab -->
        <div id="businessHoursTab" class="tab-content">
            <h2 class="mb-2">Gerenciar Horários de Funcionamento</h2>

            <div class="card">
                <div class="alert alert-info">
                    <strong>Informação:</strong> Configure os horários de abertura e fechamento para cada dia da semana.
                    Os agendamentos só poderão ser feitos dentro desses horários.
                </div>

                <form id="businessHoursForm">
                    <!-- Segunda-feira -->
                    <div class="form-group">
                        <label class="form-label">Segunda-feira</label>
                        <div class="grid grid-2">
                            <div>
                                <label>Abertura</label>
                                <input type="time" placeholder="08:00" id="segunda_abertura" class="form-control" value="08:00" placeholder="08:00">
                            </div>
                            <div>
                                <label>Fechamento</label>
                                <input type="time" placeholder="08:00" id="segunda_fechamento" class="form-control" value="18:00" placeholder="18:00">
                            </div>
                        </div>
                    </div>

                    <!-- Terça-feira -->
                    <div class="form-group">
                        <label class="form-label">Terça-feira</label>
                        <div class="grid grid-2">
                            <div>
                                <label>Abertura</label>
                                <input type="time" placeholder="08:00" id="terca_abertura" class="form-control" value="08:00">
                            </div>
                            <div>
                                <label>Fechamento</label>
                                <input type="time" placeholder="08:00" id="terca_fechamento" class="form-control" value="18:00">
                            </div>
                        </div>
                    </div>

                    <!-- Quarta-feira -->
                    <div class="form-group">
                        <label class="form-label">Quarta-feira</label>
                        <div class="grid grid-2">
                            <div>
                                <label>Abertura</label>
                                <input type="time" placeholder="08:00" id="quarta_abertura" class="form-control" value="08:00">
                            </div>
                            <div>
                                <label>Fechamento</label>
                                <input type="time" placeholder="08:00" id="quarta_fechamento" class="form-control" value="18:00">
                            </div>
                        </div>
                    </div>

                    <!-- Quinta-feira -->
                    <div class="form-group">
                        <label class="form-label">Quinta-feira</label>
                        <div class="grid grid-2">
                            <div>
                                <label>Abertura</label>
                                <input type="time" placeholder="08:00" id="quinta_abertura" class="form-control" value="08:00">
                            </div>
                            <div>
                                <label>Fechamento</label>
                                <input type="time" placeholder="08:00" id="quinta_fechamento" class="form-control" value="18:00">
                            </div>
                        </div>
                    </div>

                    <!-- Sexta-feira -->
                    <div class="form-group">
                        <label class="form-label">Sexta-feira</label>
                        <div class="grid grid-2">
                            <div>
                                <label>Abertura</label>
                                <input type="time" placeholder="08:00" id="sexta_abertura" class="form-control" value="08:00">
                            </div>
                            <div>
                                <label>Fechamento</label>
                                <input type="time" placeholder="08:00" id="sexta_fechamento" class="form-control" value="18:00">
                            </div>
                        </div>
                    </div>

                    <!-- Sábado -->
                    <div class="form-group">
                        <label class="form-label">Sábado</label>
                        <div class="grid grid-2">
                            <div>
                                <label>Abertura</label>
                                <input type="time" placeholder="08:00" id="sabado_abertura" class="form-control" value="08:00">
                            </div>
                            <div>
                                <label>Fechamento</label>
                                <input type="time" placeholder="08:00" id="sabado_fechamento" class="form-control" value="18:00">
                            </div>
                        </div>
                    </div>

                    <!-- Domingo -->
                    <div class="form-group">
                        <label class="form-label">Domingo</label>
                        <div class="checkbox-group">
                            <input type="checkbox" id="domingo_fechado" onchange="toggleDomingo()">
                            <label for="domingo_fechado">Fechado aos domingos</label>
                        </div>
                        <div class="grid grid-2" id="domingo_hours" style="display: none;">
                            <div>
                                <label>Abertura</label>
                                <input type="time" placeholder="08:00" id="domingo_abertura" class="form-control">
                            </div>
                            <div>
                                <label>Fechamento</label>
                                <input type="time" placeholder="08:00" id="domingo_fechamento" class="form-control">
                            </div>
                        </div>
                    </div>

                    <!-- Botões -->
                    <div class="d-flex gap-1 mt-3">
                        <button type="submit" class="btn btn-primary" style="flex: 1;">
                            Salvar Horários
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="loadCurrentHours()" style="flex: 1;">
                            Carregar Horários Atuais
                        </button>
                    </div>
                </form>
            </div>

            <!-- Mensagens -->
            <div id="businessHoursMessages"></div>
        </div>

        <!-- Company Profile Tab -->
        <div id="companyProfileTab" class="tab-content">
            <h2 class="mb-2">Configurações da Empresa</h2>

            <div class="alert alert-info mb-3">
                <strong>Informações da Empresa:</strong> Configure os dados que aparecerão para seus clientes quando eles selecionarem seu salão.
            </div>

            <!-- Sub-tabs for Company Profile -->
            <div class="card mb-3">
                <div class="d-flex gap-1" style="flex-wrap: wrap;">
                    <button class="btn btn-primary sub-tab-btn active" data-sub-tab="basic-info">Informações Básicas</button>
                    <button class="btn btn-outline sub-tab-btn" data-sub-tab="appearance">Aparência do Card</button>
                    <button class="btn btn-outline sub-tab-btn" data-sub-tab="owner-info">Informações do Dono</button>
                    <button class="btn btn-outline sub-tab-btn" data-sub-tab="sharing">Compartilhar</button>
                </div>
            </div>

            <!-- Basic Info Sub-tab -->
            <div id="basic-infoSubTab" class="sub-tab-content active">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Informações Básicas da Empresa</h3>
                    </div>

                    <form id="companyBasicForm">
                        <div class="grid grid-2">
                            <div class="form-group">
                                <label class="form-label">Nome da Empresa *</label>
                                <input type="text" id="companyName" class="form-control" required placeholder="Ex: Barbearia do João">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Telefone</label>
                                <input type="tel" id="companyPhone" class="form-control" placeholder="(11) 99999-9999">
                            </div>
                        </div>

                         <div class="grid grid-2">
                             <div class="form-group">
                                 <label class="form-label">Rua e Número</label>
                                 <input type="text" id="companyStreet" class="form-control" placeholder="Ex: Rua das Flores, 123">
                             </div>
                             <div class="form-group">
                                 <label class="form-label">Bairro/Região</label>
                                 <input type="text" id="companyNeighborhood" class="form-control" placeholder="Ex: Centro, São Paulo">
                             </div>
                         </div>

                        <div class="form-group">
                            <label class="form-label">Descrição (opcional)</label>
                            <textarea id="companyDescription" class="form-control" rows="3" placeholder="Descreva seu negócio, especialidades, etc."></textarea>
                        </div>

                        <div class="d-flex gap-1 mt-3">
                            <button type="submit" class="btn btn-primary">Salvar Informações Básicas</button>
                            <button type="button" class="btn btn-secondary" id="loadCompanyBasic">Carregar Dados</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Appearance Sub-tab -->
            <div id="appearanceSubTab" class="sub-tab-content">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Aparência do Card para Clientes</h3>
                    </div>

                    <form id="companyAppearanceForm">
                        <div class="alert alert-info mb-3">
                            <strong>Preview:</strong> Configure como seu salão aparecerá para os clientes na página de seleção.
                        </div>

                        <div class="form-group">
                            <label class="form-label">Nome no Card</label>
                            <input type="text" id="cardDisplayName" class="form-control" placeholder="Nome que aparecerá no card" readonly>
                            <small class="text-muted">Será preenchido automaticamente com o nome da empresa</small>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Localização no Card</label>
                            <input type="text" id="cardLocation" class="form-control" placeholder="Ex: Centro, São Paulo" readonly>
                            <small class="text-muted">Será preenchido automaticamente com o bairro/região definido nas Informações Básicas</small>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Logo/Foto do Salão</label>
                            <div class="d-flex gap-1 align-center">
                                <input type="file" id="companyLogo" class="form-control" accept="image/*" style="flex: 1;">
                                <button type="button" class="btn btn-outline" id="uploadLogo" disabled>Upload</button>
                            </div>
                            <small class="text-muted">Formato: JPG, PNG. Tamanho máximo: 2MB</small>
                            <div id="logoPreview" class="mt-2" style="display: none;">
                                <img id="logoImage" src="" alt="Logo Preview" style="max-width: 200px; max-height: 150px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Descrição Curta</label>
                            <textarea id="cardDescription" class="form-control" rows="2" maxlength="150" placeholder="Descrição breve que aparecerá no card"></textarea>
                            <small class="text-muted">Máximo 150 caracteres</small>
                        </div>

                        <div class="d-flex gap-1 mt-3">
                            <button type="submit" class="btn btn-primary">Salvar Aparência</button>
                            <button type="button" class="btn btn-secondary" id="loadCompanyAppearance">Carregar Dados</button>
                        </div>
                    </form>
                </div>

                <!-- Live Preview -->
                <div class="card mt-3">
                    <div class="card-header">
                        <h3 class="card-title">Preview do Card</h3>
                    </div>
                    <div id="cardPreview" class="company-card-preview">
                        <!-- Preview será gerado dinamicamente -->
                    </div>
                </div>
            </div>

            <!-- Owner Info Sub-tab -->
            <div id="owner-infoSubTab" class="sub-tab-content">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Informações do Dono</h3>
                    </div>

                    <form id="companyOwnerForm">
                        <div class="alert alert-info mb-3">
                            <strong>Informações Pessoais:</strong> Estas informações podem aparecer no perfil do salão.
                        </div>

                        <div class="grid grid-2">
                            <div class="form-group">
                                <label class="form-label">Nome do Dono</label>
                                <input type="text" id="ownerName" class="form-control" placeholder="Seu nome completo" readonly>
                                <small class="text-muted">Vem do seu perfil de usuário</small>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Telefone Pessoal</label>
                                <input type="tel" id="ownerPersonalPhone" class="form-control" placeholder="(11) 99999-9999" readonly>
                                <small class="text-muted">Será replicado do telefone da empresa</small>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">E-mail de Contato</label>
                            <input type="email" id="ownerEmail" class="form-control" placeholder="seu@email.com" readonly>
                            <small class="text-muted">Vem do seu perfil de usuário (apenas admin pode alterar)</small>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Experiência/Especialidades</label>
                            <textarea id="ownerExperience" class="form-control" rows="3" placeholder="Conte um pouco sobre sua experiência e especialidades"></textarea>
                        </div>

                        <div class="d-flex gap-1 mt-3">
                            <button type="submit" class="btn btn-primary">Salvar Informações do Dono</button>
                            <button type="button" class="btn btn-secondary" id="loadCompanyOwner">Carregar Dados</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Sharing Sub-tab -->
            <div id="sharingSubTab" class="sub-tab-content">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Compartilhar Salão</h3>
                    </div>

                    <div class="alert alert-info mb-3">
                        <strong>Compartilhe este link:</strong> Use este link único para direcionar seus clientes diretamente para a seleção do seu salão.
                    </div>

                    <div class="form-group">
                        <label class="form-label">Link de Agendamento</label>
                        <div class="d-flex gap-1">
                            <input type="text" id="companyShareLink" class="form-control" readonly>
                            <button class="btn btn-outline" id="copyShareLink" title="Copiar link">
                                📋 Copiar
                            </button>
                        </div>
                        <small class="text-muted">Este link leva diretamente para a seleção do seu salão</small>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Código QR (em breve)</label>
                        <div class="alert alert-warning">
                            <strong>Em desenvolvimento:</strong> Em breve você poderá gerar um código QR para compartilhar fisicamente.
                        </div>
                    </div>
                </div>
            </div>


            <!-- Mensagens -->
            <div id="companyProfileMessages"></div>
        </div>

        <!-- Reports Tab -->
        <div id="reportsTab" class="tab-content">
            <h2 class="mb-2">Relatórios</h2>

            <div class="grid grid-2 mb-3">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Relatório de Faturamento</h3>
                    </div>
                    <div class="form-group">
                        <select id="revenueReportPeriod" class="form-control form-select">
                            <option value="daily">Diário</option>
                            <option value="weekly">Semanal</option>
                            <option value="monthly">Mensal</option>
                        </select>
                    </div>
                    <button class="btn btn-primary" id="generateRevenueReport">Gerar Relatório</button>
                    <div id="revenueReportResult" class="mt-2"></div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Novos Clientes</h3>
                    </div>
                    <div class="form-group">
                        <select id="newClientsReportPeriod" class="form-control form-select">
                            <option value="daily">Diário</option>
                            <option value="weekly">Semanal</option>
                            <option value="monthly">Mensal</option>
                        </select>
                    </div>
                    <button class="btn btn-primary" id="generateNewClientsReport">Gerar Relatório</button>
                    <div id="newClientsReportResult" class="mt-2"></div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Performance dos Profissionais</h3>
                </div>
                <div class="form-group">
                    <select id="performanceReportPeriod" class="form-control form-select">
                        <option value="daily">Diário</option>
                        <option value="weekly">Semanal</option>
                        <option value="monthly">Mensal</option>
                    </select>
                </div>
                <button class="btn btn-primary" id="generatePerformanceReport">Gerar Relatório</button>
                <div id="performanceReportResult" class="mt-2"></div>
            </div>
        </div>
    </main>

    <!-- Modal para CRUD -->
    <div id="crudModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">Título</h3>
                <button class="modal-close" id="closeModal">&times;</button>
            </div>
            <form id="crudForm">
                <div id="modalBody">
                    <!-- Conteúdo dinâmico -->
                </div>
                <div class="d-flex gap-1 mt-2">
                    <button type="submit" class="btn btn-primary" style="flex: 1;">Salvar</button>
                    <button type="button" class="btn btn-secondary" id="cancelModal" style="flex: 1;">Cancelar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal para Detalhes do Agendamento -->
    <div id="appointmentDetailsModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3>Detalhes do Agendamento</h3>
                <button class="modal-close" id="closeDetailsModal">&times;</button>
            </div>
            <div id="appointmentDetailsBody">
                <!-- Conteúdo dinâmico dos detalhes -->
            </div>
            <div class="d-flex gap-1 mt-2">
                <button class="btn btn-secondary" id="closeDetailsBtn" style="flex: 1;">Fechar</button>
            </div>
        </div>
    </div>

    <!-- Modal de Confirmação de Presença -->
    <div id="presenceModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Confirmação de Presença</h3>
            </div>
            <div id="presenceModalBody">
                <!-- Conteúdo dinâmico da notificação -->
            </div>
            <div class="d-flex gap-1 mt-2">
                <button class="btn btn-success" id="confirmPresenceBtn" style="flex: 1;">
                    ✅ Cliente Apareceu
                </button>
                <button class="btn btn-danger" id="denyPresenceBtn" style="flex: 1;">
                    ❌ Cliente Não Apareceu
                </button>
            </div>
        </div>
    </div>

    <!-- Container de Notificações -->
    <div id="notificationsContainer" class="notifications-container">
        <!-- Notificações aparecerão aqui -->
    </div>

    <!-- Modal de Troca de Senha Obrigatória -->
    <div id="changePasswordModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>🔐 Troca de Senha Obrigatória</h3>
            </div>
            <form id="changePasswordForm">
                <div class="form-group">
                    <label class="form-label">Senha Atual</label>
                    <input type="password" id="currentPassword" class="form-control" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Nova Senha (mínimo 6 caracteres)</label>
                    <input type="password" id="newPassword" class="form-control" required minlength="6">
                </div>
                <div class="form-group">
                    <label class="form-label">Confirmar Nova Senha</label>
                    <input type="password" id="confirmPassword" class="form-control" required minlength="6">
                </div>
                <div class="d-flex gap-1 mt-2">
                    <button type="submit" class="btn btn-primary" style="flex: 1;">Alterar Senha</button>
                    <button type="button" class="btn btn-secondary" id="cancelChangePassword" style="flex: 1;">Cancelar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Scripts -->
    <script src="/frontend/config.js"></script>
    <script src="/frontend/app.js"></script>
    <script>
        // Variáveis globais
        let currentTab = 'dashboard';
        let currentEditId = null;
        let currentEditType = null;
        let currentUser = null; // Informações do usuário logado

        // Sistema de atualização automática
        let autoRefreshInterval = null;
        const AUTO_REFRESH_INTERVAL = 30000; // 30 segundos

        // Variável global para controlar bloqueios
        let subscriptionBlocked = false;

        // Inicialização
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('🚀 DOMContentLoaded - Iniciando aplicação');

            // Verificar autenticação
            if (!AuthGuard.requireAuth(['dono', 'admin'])) return;

            // Carregar informações do usuário primeiro
            try {
                console.log('[INIT] Carregando informações do usuário...');
                const userInfo = await api.request('/auth/me');
                currentUser = userInfo;
                console.log('[INIT] Usuário carregado:', currentUser);

                // Carregar e exibir informações na navbar
                await loadNavbarInfo();
            } catch (error) {
                console.error('[INIT] Erro ao carregar usuário:', error);
                UI.showError('Erro ao carregar informações do usuário');
                return;
            }

            // Verificar se é primeiro login e forçar troca de senha
            checkFirstLogin();

            // Aguardar um pouco para garantir que todos os elementos foram criados
            setTimeout(() => {
                console.log('⏳ Timeout inicial - verificando elementos...');

                // Verificar se elementos existem antes de inicializar
                const businessHoursTab = document.getElementById('businessHoursTab');
                const dashboardTab = document.getElementById('dashboardTab');

                console.log('Elementos encontrados no DOM:');
                console.log('- businessHoursTab:', businessHoursTab ? '✅ Existe' : '❌ Não encontrado');
                console.log('- dashboardTab:', dashboardTab ? '✅ Existe' : '❌ Não encontrado');

                // Inicializar abas - esconder todas exceto dashboard
                initializeTabs();

                setupEventListeners();
                loadDashboard();

                // Inicializar sistema de horários
                initializeBusinessHours();

                // Inicializar sistema de monitoramento de presença
                presenceMonitor.start();

                // Iniciar atualização automática
                startAutoRefresh();

                console.log('✅ Inicialização completa');
            }, 100);
        });

        // Sistema de atualização automática
        function startAutoRefresh() {
            console.log('[AUTO-REFRESH] Iniciando atualização automática a cada 30 segundos');

            // Parar intervalo existente se houver
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
            }

            // Iniciar novo intervalo
            autoRefreshInterval = setInterval(() => {
                console.log('[AUTO-REFRESH] Atualizando dados automaticamente...');

                // Só atualizar se estiver na aba do dashboard
                    if (currentTab === 'dashboard') {
                        loadDashboard().catch(error => {
                            console.error('[AUTO-REFRESH] Erro na atualização automática:', error);
                        });
                    } else if (currentTab === 'appointments' && currentSubTab === 'history') {
                        loadAppointmentsHistory().catch(error => {
                            console.error('[AUTO-REFRESH] Erro na atualização automática do histórico:', error);
                        });
                    }
            }, AUTO_REFRESH_INTERVAL);
        }

        function stopAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
                console.log('[AUTO-REFRESH] Atualização automática parada');
            }
        }

        // Inicializar sistema de abas
        function initializeTabs() {
            console.log('Inicializando sistema de abas...');

            // Esconder todas as abas inicialmente
            const allTabs = document.querySelectorAll('.tab-content');
            allTabs.forEach(tab => {
                if (tab) {
                    tab.style.display = 'none';
                    tab.classList.remove('active');
                }
            });

            // Mostrar apenas a aba do dashboard
            const dashboardTab = document.getElementById('dashboardTab');
            if (dashboardTab) {
                dashboardTab.style.display = 'block';
                dashboardTab.classList.add('active');
                console.log('Aba dashboard inicializada como ativa');
            }

            // Configurar botão ativo inicial
            const dashboardButton = document.querySelector('[data-tab="dashboard"]');
            if (dashboardButton) {
                dashboardButton.className = 'btn btn-primary tab-btn active';
            }

            console.log('Sistema de abas inicializado');
        }

        // Inicializar sistema de horários
        function initializeBusinessHours() {
            console.log('Inicializando sistema de horários...');

            // Verificar se elementos existem antes de configurar
            const businessHoursForm = document.getElementById('businessHoursForm');
            const businessHoursTab = document.getElementById('businessHoursTab');
            const domingoFechado = document.getElementById('domingo_fechado');

            if (businessHoursForm) {
                console.log('✅ Formulário de horários encontrado');
            } else {
                console.error('❌ Formulário de horários NÃO encontrado');
            }

            if (businessHoursTab) {
                console.log('✅ Container da aba de horários encontrado');
                // Garantir que está oculto inicialmente
                businessHoursTab.style.display = 'none';
                businessHoursTab.classList.remove('active');
            } else {
                console.error('❌ Container da aba de horários NÃO encontrado');
            }

            if (domingoFechado) {
                console.log('✅ Checkbox do domingo encontrado');
                // Garantir estado inicial correto
                toggleDomingo();
            } else {
                console.warn('⚠️ Checkbox do domingo NÃO encontrado');
            }

            // Verificar se há token JWT válido
            const token = TokenManager.get();
            if (!token) {
                console.warn('⚠️ Token JWT não encontrado. Sistema de horários pode não funcionar corretamente.');
            } else {
                console.log('✅ Token JWT encontrado');
            }

            console.log('Sistema de horários inicializado com sucesso');
        }

        // Configurar event listeners
        function setupEventListeners() {
            // Logout
            document.getElementById('logoutBtn').addEventListener('click', () => api.logout());

            // Tabs
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', () => switchTab(btn.dataset.tab));
            });

            // Modal
            document.getElementById('closeModal').addEventListener('click', closeModal);
            document.getElementById('cancelModal').addEventListener('click', closeModal);
            document.getElementById('crudModal').addEventListener('click', (e) => {
                if (e.target.id === 'crudModal') closeModal();
            });

            // CRUD buttons
            document.getElementById('addClientBtn').addEventListener('click', () => openClientModal());
            document.getElementById('addServiceBtn').addEventListener('click', () => openServiceModal());
            document.getElementById('addProfessionalBtn').addEventListener('click', () => openProfessionalModal());
            document.getElementById('refreshAppointmentsBtn').addEventListener('click', loadAppointments);

            // Professional service association buttons
            const professionalSelect = document.getElementById('professionalSelect');
            const saveServiceAssociationBtn = document.getElementById('saveServiceAssociation');
            const cancelServiceAssociationBtn = document.getElementById('cancelServiceAssociation');
            const selectAllServicesBtn = document.getElementById('selectAllServices');

            if (professionalSelect) {
                professionalSelect.addEventListener('change', handleProfessionalSelect);
            }
            if (saveServiceAssociationBtn) {
                saveServiceAssociationBtn.addEventListener('click', handleSaveServiceAssociation);
            }
            if (cancelServiceAssociationBtn) {
                cancelServiceAssociationBtn.addEventListener('click', handleCancelServiceAssociation);
            }
            if (selectAllServicesBtn) {
                selectAllServicesBtn.addEventListener('click', handleSelectAllServices);
            }

            // Sub-tabs
            document.querySelectorAll('.sub-tab-btn').forEach(btn => {
                btn.addEventListener('click', (event) => {
                    // Verificar se é sub-aba de profissionais
                    const parentTab = btn.closest('.tab-content');
                    if (parentTab && parentTab.id === 'professionalsTab') {
                        switchProfessionalSubTab(btn.dataset.subTab);
                    } else {
                        switchSubTab(btn.dataset.subTab);
                    }
                });
            });

            // History filters and buttons
            document.getElementById('refreshHistoryBtn').addEventListener('click', loadAppointmentsHistory);
            document.getElementById('applyHistoryFilters').addEventListener('click', applyHistoryFilters);
            document.getElementById('clearHistoryFilters').addEventListener('click', clearHistoryFilters);

            // Appointment details modal
            document.getElementById('closeDetailsModal').addEventListener('click', closeAppointmentDetailsModal);
            document.getElementById('closeDetailsBtn').addEventListener('click', closeAppointmentDetailsModal);
            document.getElementById('appointmentDetailsModal').addEventListener('click', (e) => {
                if (e.target.id === 'appointmentDetailsModal') closeAppointmentDetailsModal();
            });

            // Reports
            document.getElementById('generateRevenueReport').addEventListener('click', generateRevenueReport);
            document.getElementById('generateNewClientsReport').addEventListener('click', generateNewClientsReport);
            document.getElementById('generatePerformanceReport').addEventListener('click', generatePerformanceReport);

            // Company Profile
            console.log('[INIT] Configurando event listeners para sub-abas da empresa...');
            const companySubTabButtons = document.querySelectorAll('#companyProfileTab .sub-tab-btn');
            console.log(`[INIT] Encontrados ${companySubTabButtons.length} botões de sub-aba da empresa`);
            companySubTabButtons.forEach(btn => {
                console.log(`[INIT] Configurando listener para botão: ${btn.dataset.subTab}`);
                btn.addEventListener('click', (event) => {
                    console.log(`[EVENT] Clicado botão de sub-aba: ${btn.dataset.subTab}`);
                    event.preventDefault();
                    switchCompanySubTab(btn.dataset.subTab);
                });
            });

            // Company Profile Forms
            document.getElementById('companyBasicForm').addEventListener('submit', handleCompanyBasicSubmit);
            document.getElementById('loadCompanyBasic').addEventListener('click', loadCompanyBasic);

            // Auto-atualizar campos relacionados quando campos básicos mudarem
            document.getElementById('companyName').addEventListener('input', updateCardNameFromBasic);
            document.getElementById('companyNeighborhood').addEventListener('input', updateCardLocationFromBasic);
            document.getElementById('companyPhone').addEventListener('input', updateOwnerPhoneFromBasic);
            document.getElementById('companyDescription').addEventListener('input', updateCardDescriptionFromBasic);

            document.getElementById('companyAppearanceForm').addEventListener('submit', handleCompanyAppearanceSubmit);
            document.getElementById('loadCompanyAppearance').addEventListener('click', loadCompanyAppearance);
            document.getElementById('companyLogo').addEventListener('change', handleLogoPreview);
            document.getElementById('uploadLogo').addEventListener('click', handleLogoUpload);

            document.getElementById('companyOwnerForm').addEventListener('submit', handleCompanyOwnerSubmit);
            document.getElementById('loadCompanyOwner').addEventListener('click', loadCompanyOwner);

            document.getElementById('copyShareLink').addEventListener('click', copyShareLink);

            // Form submit
            document.getElementById('crudForm').addEventListener('submit', handleCrudSubmit);

            // Change password modal
            document.getElementById('changePasswordForm').addEventListener('submit', handleChangePassword);
            document.getElementById('cancelChangePassword').addEventListener('click', hideChangePasswordModal);

            // Business Hours event listeners
            const businessHoursForm = document.getElementById('businessHoursForm');
            if (businessHoursForm) {
                businessHoursForm.addEventListener('submit', handleBusinessHoursSubmit);
            }

            // Domingo checkbox event listener
            const domingoFechado = document.getElementById('domingo_fechado');
            if (domingoFechado) {
                domingoFechado.addEventListener('change', toggleDomingo);
            }

            // Presence modal event listeners
            const confirmPresenceBtn = document.getElementById('confirmPresenceBtn');
            const denyPresenceBtn = document.getElementById('denyPresenceBtn');

            if (confirmPresenceBtn) {
                confirmPresenceBtn.addEventListener('click', () => {
                    const appointmentId = confirmPresenceBtn.dataset.appointmentId;
                    if (appointmentId) {
                        presenceMonitor.confirmPresence(parseInt(appointmentId));
                    }
                });
            }

            if (denyPresenceBtn) {
                denyPresenceBtn.addEventListener('click', () => {
                    const appointmentId = denyPresenceBtn.dataset.appointmentId;
                    if (appointmentId) {
                        presenceMonitor.denyPresence(parseInt(appointmentId));
                    }
                });
            }

            // Fechar modal de presença ao clicar fora
            const presenceModal = document.getElementById('presenceModal');
            if (presenceModal) {
                presenceModal.addEventListener('click', (e) => {
                    if (e.target.id === 'presenceModal') {
                        presenceModal.classList.remove('show');
                    }
                });
            }
        }

        // Carregar informações para a navbar
        async function loadNavbarInfo() {
            try {
                console.log('[NAVBAR] Carregando informações para navbar...');

                // Carregar dados da empresa
                const companyId = currentUser.id;
                const companyData = await api.request(`/salons/${companyId}`);

                // Atualizar elementos da navbar
                const welcomeMessage = document.getElementById('welcomeMessage');
                const salonName = document.getElementById('salonName');
                const salonLogo = document.getElementById('salonLogo');

                if (salonName) {
                    salonName.textContent = companyData.nome || 'Aluvi';
                }

                if (welcomeMessage) {
                    const ownerName = companyData.owner_name || currentUser.nome || 'Dono';
                    welcomeMessage.textContent = `Olá, ${ownerName}`;
                }

                // Atualizar logo da empresa
                if (salonLogo && companyData.logo) {
                    salonLogo.src = companyData.logo;
                    salonLogo.style.display = 'block';
                    salonLogo.alt = `Logo ${companyData.nome || 'Empresa'}`;
                    console.log('[NAVBAR] Logo carregada:', companyData.logo);
                } else if (salonLogo) {
                    salonLogo.style.display = 'none';
                }

                console.log('[NAVBAR] Informações da navbar atualizadas:', {
                    empresa: companyData.nome,
                    dono: companyData.owner_name || currentUser.nome,
                    logo: companyData.logo
                });

            } catch (error) {
                console.error('[NAVBAR] Erro ao carregar informações da navbar:', error);

                // Fallback: mostrar valores padrão
                const welcomeMessage = document.getElementById('welcomeMessage');
                const salonName = document.getElementById('salonName');
                const salonLogo = document.getElementById('salonLogo');

                if (salonName) {
                    salonName.textContent = 'Aluvi';
                }
                if (welcomeMessage) {
                    welcomeMessage.textContent = 'Carregando...';
                }
                if (salonLogo) {
                    salonLogo.style.display = 'none';
                }
            }
        }

        // Alternar entre tabs
        function switchTab(tabName) {
            console.log(`🔄 Trocando para aba: ${tabName}`);

            // DEBUG: Verificar estado atual antes da mudança
            console.log('📊 Estado atual das abas:');
            const allTabsBefore = document.querySelectorAll('.tab-content');
            allTabsBefore.forEach(tab => {
                const isVisible = tab.style.display !== 'none' && tab.classList.contains('active');
                console.log(`   ${tab.id}: ${isVisible ? 'VISÍVEL' : 'OCULTO'}`);
            });

            // Primeiro, esconder TODAS as seções
            console.log('🔽 Escondendo todas as seções...');
            const allTabContents = document.querySelectorAll('.tab-content');
            allTabContents.forEach(content => {
                if (content) {
                    content.style.display = 'none';
                    content.classList.remove('active');
                }
            });

            // Remover classe active de TODOS os botões
            console.log('🔘 Removendo classe active de todos os botões...');
            const allTabButtons = document.querySelectorAll('.tab-btn');
            allTabButtons.forEach(btn => {
                if (btn) {
                    btn.className = 'btn btn-outline tab-btn';
                }
            });

            // Ativar o botão clicado
            console.log(`🎯 Ativando botão: [data-tab="${tabName}"]`);
            const activeButton = document.querySelector(`[data-tab="${tabName}"]`);
            if (activeButton) {
                activeButton.className = 'btn btn-primary tab-btn active';
                console.log('✅ Botão ativado com sucesso');
            } else {
                console.error('❌ Botão não encontrado no DOM');
            }

            // Mostrar apenas a seção selecionada
            // Converter kebab-case para camelCase e adicionar 'Tab'
            const targetTabId = kebabToCamel(tabName) + 'Tab';
            console.log(`🎨 Procurando seção: ${targetTabId} (de: ${tabName})`);

            const targetTab = document.getElementById(targetTabId);
            if (targetTab) {
                console.log('✅ Seção encontrada, ativando...');
                targetTab.style.display = 'block';
                targetTab.classList.add('active');
                console.log(`🎉 Aba ${tabName} ativada e visível`);

                // DEBUG: Verificar se realmente está visível
                setTimeout(() => {
                    const isReallyVisible = targetTab.style.display !== 'none' && targetTab.classList.contains('active');
                    console.log(`🔍 Verificação final - ${targetTabId} está ${isReallyVisible ? 'VISÍVEL' : 'OCULTO'}`);
                }, 50);

            } else {
                console.error(`❌ Aba ${targetTabId} não encontrada no DOM`);
                console.log('📋 Abas disponíveis no DOM:');
                const allTabs = document.querySelectorAll('.tab-content');
                allTabs.forEach(tab => {
                    console.log(`   - ${tab.id}`);
                });
                return;
            }

            currentTab = tabName;
            console.log(`📝 currentTab definido como: ${currentTab}`);

            // Carregar dados da tab
            console.log(`📥 Carregando dados para aba: ${tabName}`);
            switch(tabName) {
                case 'dashboard':
                    loadDashboard();
                    break;
                case 'appointments':
                    loadAppointments();
                    break;
                case 'clients':
                    loadClients();
                    break;
                case 'services':
                    loadServices();
                    break;
                case 'professionals':
                    switchSubTab('manage');
                    loadProfessionals();
                    break;
                case 'business-hours':
                    console.log('⏰ Iniciando carregamento de horários...');
                    loadCurrentHours();
                    break;
                case 'company-profile':
                    console.log('🏢 Iniciando aba empresa...');
                    console.log('[COMPANY-INIT] Verificando estado inicial das sub-abas...');
                    document.querySelectorAll('#companyProfileTab .sub-tab-content').forEach(content => {
                        const isActive = content.classList.contains('active');
                        console.log(`[COMPANY-INIT] ${content.id}: active=${isActive}`);
                    });
                    // Ativar primeira sub-aba por padrão
                    console.log('[COMPANY-INIT] Ativando basic-info por padrão');
                    switchCompanySubTab('basic-info');
                    break;
                default:
                    console.warn(`⚠️ Aba não reconhecida: ${tabName}`);
            }

            console.log(`✅ Troca para aba ${tabName} concluída`);
        }

        // Verificar se é primeiro login e forçar troca de senha
        async function checkFirstLogin() {
            try {
                console.log('[FIRST_LOGIN] Verificando se é primeiro login...');
                const userInfo = await api.request('/auth/me');
                console.log('[FIRST_LOGIN] Informações do usuário:', userInfo);

                // Armazenar informações do usuário logado
                currentUser = userInfo;

                // Verificar se é senha temporária ou primeiro login
                if (userInfo.senha_temporaria || userInfo.primeiro_login) {
                    console.log('[FIRST_LOGIN] Primeiro login detectado - forçando troca de senha');
                    showChangePasswordModal(true); // true = obrigatório
                    return;
                }

                console.log('[FIRST_LOGIN] Não é primeiro login - continuando normalmente');
            } catch (error) {
                console.error('[FIRST_LOGIN] Erro ao verificar primeiro login:', error);
                // Em caso de erro, continuar normalmente
            }
        }

        // Mostrar modal de troca de senha
        function showChangePasswordModal(required = false) {
            const modal = document.getElementById('changePasswordModal');
            const form = document.getElementById('changePasswordForm');

            if (required) {
                // Se obrigatório, não permitir fechar
                modal.style.display = 'flex';
                modal.setAttribute('data-required', 'true');
            } else {
                modal.classList.add('show');
            }

            // Limpar formulário
            form.reset();
        }

        // Esconder modal de troca de senha
        function hideChangePasswordModal() {
            const modal = document.getElementById('changePasswordModal');
            const isRequired = modal.getAttribute('data-required') === 'true';

            if (!isRequired) {
                modal.classList.remove('show');
            }
        }

        // Processar troca de senha
        async function handleChangePassword(event) {
            event.preventDefault();

            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            // Validações
            if (!currentPassword) {
                UI.showError('Por favor, informe a senha atual.');
                return;
            }

            if (!newPassword || newPassword.length < 6) {
                UI.showError('Nova senha deve ter pelo menos 6 caracteres.');
                return;
            }

            if (newPassword !== confirmPassword) {
                UI.showError('Nova senha e confirmação não coincidem.');
                return;
            }

            try {
                const response = await api.request('/auth/change-password', {
                    method: 'POST',
                    body: JSON.stringify({
                        senha_atual: currentPassword,
                        nova_senha: newPassword
                    })
                });

                if (response.success) {
                    UI.showSuccess('Senha alterada com sucesso!');
                    hideChangePasswordModal();

                    // Se era obrigatório, recarregar a página
                    const modal = document.getElementById('changePasswordModal');
                    if (modal.getAttribute('data-required') === 'true') {
                        setTimeout(() => {
                            window.location.reload();
                        }, 1500);
                    }
                } else {
                    UI.showError(response.error || 'Erro ao alterar senha.');
                }
            } catch (error) {
                console.error('Erro ao alterar senha:', error);
                UI.showError('Erro ao alterar senha. Verifique sua conexão.');
            }
        }

        // Verificar status da mensalidade
        async function checkSubscriptionStatus() {
            try {
                console.log('[SUBSCRIPTION] Verificando status da mensalidade...');
                const userInfo = await api.request('/auth/me');
                console.log('[SUBSCRIPTION] Status da mensalidade:', userInfo);

                const subscriptionCard = document.getElementById('subscriptionStatus');
                const subscriptionDetails = document.getElementById('subscriptionDetails');

                if (!userInfo.mensalidade_pago) {
                    // Mensalidade não paga - mostrar aviso e bloquear funcionalidades
                    subscriptionBlocked = true;

                    let detailsHtml = '<p><strong>Status:</strong> Pendente</p>';
                    if (userInfo.data_vencimento_mensalidade) {
                        const vencimento = new Date(userInfo.data_vencimento_mensalidade);
                        detailsHtml += `<p><strong>Data de Vencimento:</strong> ${Formatter.date(userInfo.data_vencimento_mensalidade)}</p>`;

                        const hoje = new Date();
                        const diffTime = vencimento - hoje;
                        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

                        if (diffDays < 0) {
                            detailsHtml += `<p style="color: #dc3545;"><strong>Dias em Atraso:</strong> ${Math.abs(diffDays)} dias</p>`;
                        } else {
                            detailsHtml += `<p><strong>Dias para Vencimento:</strong> ${diffDays} dias</p>`;
                        }
                    }

                    subscriptionDetails.innerHTML = detailsHtml;
                    subscriptionCard.style.display = 'block';

                    // Bloquear funcionalidades críticas
                    disableCriticalFeatures();

                    console.log('[SUBSCRIPTION] Funcionalidades bloqueadas - mensalidade pendente');
                } else {
                    // Mensalidade paga - esconder aviso e desbloquear
                    subscriptionBlocked = false;
                    subscriptionCard.style.display = 'none';

                    // Desbloquear funcionalidades
                    enableCriticalFeatures();

                    console.log('[SUBSCRIPTION] Mensalidade em dia - funcionalidades liberadas');
                }

            } catch (error) {
                console.error('[SUBSCRIPTION] Erro ao verificar status da mensalidade:', error);
                // Em caso de erro, assumir que está tudo ok para não bloquear desnecessariamente
                subscriptionBlocked = false;
                document.getElementById('subscriptionStatus').style.display = 'none';
            }
        }

        // Bloquear funcionalidades críticas quando mensalidade estiver pendente
        function disableCriticalFeatures() {
            // Desabilitar botões de criação/edição
            const buttonsToDisable = [
                'addClientBtn',
                'addServiceBtn',
                'addProfessionalBtn',
                'refreshAppointmentsBtn',
                'generateRevenueReport',
                'generateNewClientsReport',
                'generatePerformanceReport'
            ];

            buttonsToDisable.forEach(btnId => {
                const btn = document.getElementById(btnId);
                if (btn) {
                    btn.disabled = true;
                    btn.style.opacity = '0.5';
                    btn.title = 'Funcionalidade bloqueada - regularize sua mensalidade';
                }
            });

            // Adicionar overlay em áreas críticas
            addBlockedOverlay('appointmentsTab', 'Agendamentos bloqueados - mensalidade pendente');
            addBlockedOverlay('clientsTab', 'Gerenciamento de clientes bloqueado - mensalidade pendente');
            addBlockedOverlay('servicesTab', 'Gerenciamento de serviços bloqueado - mensalidade pendente');
            addBlockedOverlay('professionalsTab', 'Gerenciamento de profissionais bloqueado - mensalidade pendente');
        }

        // Desbloquear funcionalidades quando mensalidade for paga
        function enableCriticalFeatures() {
            // Reabilitar botões
            const buttonsToEnable = [
                'addClientBtn',
                'addServiceBtn',
                'addProfessionalBtn',
                'refreshAppointmentsBtn',
                'generateRevenueReport',
                'generateNewClientsReport',
                'generatePerformanceReport'
            ];

            buttonsToEnable.forEach(btnId => {
                const btn = document.getElementById(btnId);
                if (btn) {
                    btn.disabled = false;
                    btn.style.opacity = '1';
                    btn.title = '';
                }
            });

            // Remover overlays
            removeBlockedOverlays();
        }

        // Adicionar overlay de bloqueio
        function addBlockedOverlay(containerId, message) {
            const container = document.getElementById(containerId);
            if (!container) return;

            // Verificar se já existe overlay
            if (container.querySelector('.blocked-overlay')) return;

            const overlay = document.createElement('div');
            overlay.className = 'blocked-overlay';
            overlay.innerHTML = `
                <div class="blocked-message">
                    <span class="blocked-icon">🔒</span>
                    <span class="blocked-text">${message}</span>
                </div>
            `;

            // Estilizar overlay
            overlay.style.cssText = `
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(255, 255, 255, 0.9);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10;
                border-radius: 0.25rem;
            `;

            // Tornar container relativo para posicionamento absoluto do overlay
            container.style.position = 'relative';
            container.appendChild(overlay);
        }

        // Remover overlays de bloqueio
        function removeBlockedOverlays() {
            document.querySelectorAll('.blocked-overlay').forEach(overlay => {
                overlay.remove();
            });
        }

        // Carregar dashboard
        async function loadDashboard() {
            try {
                console.log('[DASHBOARD] Iniciando carregamento do dashboard...');

                // Verificar status da mensalidade primeiro
                await checkSubscriptionStatus();

                UI.showLoading(document.getElementById('statsGrid'));
                UI.showLoading(document.getElementById('todayAppointments'));
                UI.showLoading(document.getElementById('recentAppointments'));

                // Carregar estatísticas
                try {
                    console.log('[DASHBOARD] Carregando estatísticas...');
                    const stats = await api.getDashboardStats();
                    console.log('[DASHBOARD] Dados recebidos da API:', stats);
                    displayStats(stats);
                    console.log('[DASHBOARD] Estatísticas carregadas com sucesso');
                } catch (statsError) {
                    console.error('[DASHBOARD] Erro ao carregar estatísticas:', statsError);
                    // Mostra estatísticas vazias em caso de erro
                    displayStats({
                        total_agendamentos: 0,
                        total_clientes: 0,
                        faturamento_total: 0,
                        agendamentos_hoje: 0
                    });
                }

                // Carregar agendamentos
                try {
                    console.log('[DASHBOARD] Carregando todos os agendamentos...');
                    const appointments = await api.getAppointments();
                    console.log(`[DASHBOARD] Recebidos ${appointments.length} agendamentos da API`);

                    // Filtrar apenas agendamentos com status 'agendado' (ignorar concluídos e cancelados)
                    const scheduledAppointments = appointments.filter(apt => {
                        const status = apt.status ? apt.status.toLowerCase().replace('statusagendamento.', '') : '';
                        return status === 'agendado' || status === 'pending';
                    });

                    console.log(`[DASHBOARD] ${scheduledAppointments.length} agendamentos com status 'agendado'`);

                    // Separar agendamentos de hoje
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);
                    const tomorrow = new Date(today);
                    tomorrow.setDate(tomorrow.getDate() + 1);

                    const todayAppointments = scheduledAppointments.filter(apt => {
                        const aptDate = new Date(apt.data_hora);
                        return aptDate >= today && aptDate < tomorrow;
                    });

                    // Ordenar agendamentos de hoje por horário
                    todayAppointments.sort((a, b) => new Date(a.data_hora) - new Date(b.data_hora));

                    // Agendamentos recentes (todos os agendados, ordenados por data decrescente)
                    const recentAppointments = [...scheduledAppointments].sort((a, b) => new Date(b.data_hora) - new Date(a.data_hora));

                    // Exibir agendamentos de hoje
                    displayTodayAppointments(todayAppointments);
                    console.log(`[DASHBOARD] ${todayAppointments.length} agendamentos para hoje`);

                    // Exibir agendamentos recentes (todos)
                    displayRecentAppointments(recentAppointments);
                    console.log(`[DASHBOARD] ${recentAppointments.length} agendamentos recentes exibidos`);

                } catch (appointmentsError) {
                    console.error('[DASHBOARD] Erro ao carregar agendamentos:', appointmentsError);
                    displayTodayAppointments([]);
                    displayRecentAppointments([]);
                }

                console.log('[DASHBOARD] Dashboard carregado com sucesso');
            } catch (error) {
                console.error('[DASHBOARD] Erro geral ao carregar dashboard:', error);
                handleDashboardError(error);
            }
        }

        // Tratar erros do dashboard
        function handleDashboardError(error) {
            document.getElementById('statsGrid').innerHTML =
                '<div class="alert alert-error">Erro ao carregar estatísticas. Verifique sua conexão.</div>';
            document.getElementById('recentAppointments').innerHTML =
                '<div class="alert alert-error">Erro ao carregar agendamentos recentes.</div>';
            UI.showError('Erro ao carregar dados do dashboard: ' + error.message);
        }

        // Exibir estatísticas
        function displayStats(stats) {
            const statsGrid = document.getElementById('statsGrid');

            if (!statsGrid) {
                console.error('[STATS] Elemento statsGrid não encontrado no DOM');
                return;
            }

            // Garantir que os valores sejam sempre números válidos e visíveis
            const totalAgendamentos = Number(stats?.total_agendamentos) || 0;
            const totalClientes = Number(stats?.total_clientes) || 0;
            const faturamentoTotal = Number(stats?.faturamento_total) || 0;
            const agendamentosHoje = Number(stats?.agendamentos_hoje) || 0;

            // Criar HTML dos cards de estatísticas
            const statsHtml = `
                <div class="stat-card">
                    <span class="stat-number" style="font-size: 2.5rem; font-weight: 800; display: block; margin-bottom: 0.5rem;">${totalAgendamentos}</span>
                    <div class="stat-label" style="color: var(--dark-color); font-size: 0.875rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em;">Total de Agendamentos</div>
                </div>
                <div class="stat-card">
                    <span class="stat-number" style="font-size: 2.5rem; font-weight: 800; display: block; margin-bottom: 0.5rem;">${totalClientes}</span>
                    <div class="stat-label" style="color: var(--dark-color); font-size: 0.875rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em;">Total de Clientes</div>
                </div>
                <div class="stat-card">
                    <span class="stat-number" style="font-size: 2.5rem; font-weight: 800; display: block; margin-bottom: 0.5rem;">${Formatter.currency(faturamentoTotal)}</span>
                    <div class="stat-label" style="color: var(--dark-color); font-size: 0.875rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em;">Faturamento Total</div>
                </div>
                <div class="stat-card">
                    <span class="stat-number" style="font-size: 2.5rem; font-weight: 800; display: block; margin-bottom: 0.5rem;">${agendamentosHoje}</span>
                    <div class="stat-label" style="color: var(--dark-color); font-size: 0.875rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em;">Agendamentos Hoje</div>
                </div>
            `;

            // Atualizar o conteúdo do grid
            statsGrid.innerHTML = statsHtml;

            console.log('[STATS] Estatísticas exibidas com sucesso:', {
                total_agendamentos: totalAgendamentos,
                total_clientes: totalClientes,
                faturamento_total: faturamentoTotal,
                agendamentos_hoje: agendamentosHoje
            });
        }

        // Exibir agendamentos de hoje
        function displayTodayAppointments(appointments) {
            const container = document.getElementById('todayAppointments');

            if (!appointments || appointments.length === 0) {
                container.innerHTML = '<p class="text-center" style="color: #666; padding: 2rem;">📅 Nenhum agendamento para hoje.</p>';
                return;
            }

            container.innerHTML = `
                <table class="table">
                    <thead>
                        <tr>
                            <th>Cliente</th>
                            <th>Serviço</th>
                            <th>Horário</th>
                            <th>Profissional</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${appointments.map(apt => `
                            <tr>
                                <td>${apt.cliente ? apt.cliente.nome : 'Cliente removido'}</td>
                                <td>${apt.servico ? apt.servico.nome : 'N/A'}</td>
                                <td>${new Date(apt.data_hora).toLocaleTimeString('pt-BR', {hour: '2-digit', minute: '2-digit'})}</td>
                                <td>${apt.profissional ? apt.profissional.nome : 'N/A'}</td>
                                <td><span class="badge ${getStatusClass(apt.status)}">${getStatusText(apt.status)}</span></td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        // Exibir agendamentos recentes
        function displayRecentAppointments(appointments) {
            const container = document.getElementById('recentAppointments');

            if (!appointments || appointments.length === 0) {
                container.innerHTML = '<p class="text-center" style="color: #666; padding: 2rem;">📅 Nenhum agendamento recente encontrado.</p>';
                return;
            }

            container.innerHTML = `
                <table class="table">
                    <thead>
                        <tr>
                            <th>Cliente</th>
                            <th>Serviço</th>
                            <th>Data</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${appointments.map(apt => `
                            <tr>
                                <td>${apt.cliente ? apt.cliente.nome : 'Cliente removido'}</td>
                                <td>${apt.servico ? apt.servico.nome : 'N/A'}</td>
                                <td>${Formatter.datetime(apt.data_hora)}</td>
                                <td><span class="badge ${getStatusClass(apt.status)}">${getStatusText(apt.status)}</span></td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        // Carregar agendamentos
        async function loadAppointments() {
            try {
                console.log('[APPOINTMENTS] Iniciando carregamento de agendamentos...');
                UI.showLoading(document.getElementById('appointmentsList'));

                const appointments = await api.getAppointments();
                console.log(`[APPOINTMENTS] ${appointments.length} agendamentos carregados da API`);

                // Filtrar apenas agendamentos com status 'agendado'
                const scheduledAppointments = appointments.filter(apt => {
                    const status = apt.status ? apt.status.toLowerCase().replace('statusagendamento.', '') : '';
                    return status === 'agendado' || status === 'pending';
                });

                console.log(`[APPOINTMENTS] ${scheduledAppointments.length} agendamentos com status 'agendado'`);

                displayAppointments(scheduledAppointments);
                console.log('[APPOINTMENTS] Agendamentos exibidos com sucesso');
            } catch (error) {
                console.error('[APPOINTMENTS] Erro ao carregar agendamentos:', error);
                document.getElementById('appointmentsList').innerHTML =
                    '<div class="alert alert-error">Erro ao carregar agendamentos. Verifique sua conexão.</div>';
                UI.showError('Erro ao carregar agendamentos: ' + error.message);
            }
        }

        // Exibir agendamentos
        function displayAppointments(appointments) {
            const container = document.getElementById('appointmentsList');

            if (appointments.length === 0) {
                container.innerHTML = '<p class="text-center">Nenhum agendamento encontrado.</p>';
                return;
            }

            container.innerHTML = `
                <table class="table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Cliente</th>
                            <th>Serviço</th>
                            <th>Profissional</th>
                            <th>Data</th>
                            <th>Status</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${appointments.map(apt => `
                            <tr>
                                <td>#${apt.id}</td>
                                <td>${apt.cliente ? apt.cliente.nome : 'N/A'}</td>
                                <td>${apt.servico ? apt.servico.nome : 'N/A'}</td>
                                <td>${apt.profissional ? apt.profissional.nome : 'N/A'}</td>
                                <td>${Formatter.datetime(apt.data_hora)}</td>
                                <td>
                                    <select class="form-control form-select" onchange="updateAppointmentStatus(${apt.id}, this.value)">
                                        <option value="agendado" ${apt.status === 'agendado' ? 'selected' : ''}>Agendado</option>
                                        <option value="cancelado" ${apt.status === 'cancelado' ? 'selected' : ''}>Cancelado</option>
                                        <option value="concluido" ${apt.status === 'concluido' ? 'selected' : ''}>Concluído</option>
                                    </select>
                                </td>
                                <td>
                                    <button class="btn btn-sm btn-danger" onclick="deleteAppointment(${apt.id})">Excluir</button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        // Atualizar status do agendamento
        async function updateAppointmentStatus(appointmentId, newStatus) {
            try {
                await api.updateAppointmentStatus(appointmentId, newStatus);
                UI.showSuccess('Status do agendamento atualizado com sucesso!');
            } catch (error) {
                console.error('Erro ao atualizar status:', error);
                UI.showError('Erro ao atualizar status do agendamento.');
                loadAppointments(); // Recarregar para reverter mudança
            }
        }

        // Excluir agendamento
        async function deleteAppointment(appointmentId) {
            if (!confirm('Tem certeza que deseja excluir este agendamento?')) return;

            try {
                await api.deleteAppointment(appointmentId);
                UI.showSuccess('Agendamento excluído com sucesso!');
                loadAppointments();
            } catch (error) {
                console.error('Erro ao excluir agendamento:', error);
                UI.showError('Erro ao excluir agendamento.');
            }
        }

        // Carregar clientes
        async function loadClients() {
            try {
                UI.showLoading(document.getElementById('clientsList'));
                const clients = await api.getClients();
                displayClients(clients);
            } catch (error) {
                console.error('Erro ao carregar clientes:', error);
                document.getElementById('clientsList').innerHTML =
                    '<div class="alert alert-error">Erro ao carregar clientes. Verifique sua conexão.</div>';
                UI.showError('Erro ao carregar clientes: ' + error.message);
            }
        }

        // Exibir clientes
        function displayClients(clients) {
            const container = document.getElementById('clientsList');

            if (clients.length === 0) {
                container.innerHTML = '<p class="text-center">Nenhum cliente encontrado.</p>';
                return;
            }

            container.innerHTML = `
                <table class="table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Nome</th>
                            <th>E-mail</th>
                            <th>Telefone</th>
                            <th>Pontos</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${clients.map(client => `
                            <tr>
                                <td>#${client.id}</td>
                                <td>${client.nome}</td>
                                <td>${client.email}</td>
                                <td>${client.telefone}</td>
                                <td>${client.pontos_fidelidade || 0}</td>
                                <td>
                                    <button class="btn btn-sm btn-secondary" onclick="openClientModal(${client.id})">Editar</button>
                                    <button class="btn btn-sm btn-success" onclick="addClientPoints(${client.id})">+ Pontos</button>
                                    <button class="btn btn-sm btn-danger" onclick="deleteClient(${client.id})">Excluir</button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        // Adicionar pontos ao cliente
        async function addClientPoints(clientId) {
            const points = prompt('Quantos pontos adicionar?');
            if (!points || isNaN(points)) return;

            try {
                await api.addClientPoints(clientId, parseInt(points));
                UI.showSuccess('Pontos adicionados com sucesso!');
                loadClients();
            } catch (error) {
                console.error('Erro ao adicionar pontos:', error);
                UI.showError('Erro ao adicionar pontos.');
            }
        }

        // Excluir cliente
        async function deleteClient(clientId) {
            if (!confirm('Tem certeza que deseja excluir este cliente?')) return;

            try {
                await api.deleteClient(clientId);
                UI.showSuccess('Cliente excluído com sucesso!');
                loadClients();
            } catch (error) {
                console.error('Erro ao excluir cliente:', error);
                UI.showError('Erro ao excluir cliente.');
            }
        }

        // Carregar serviços
        async function loadServices() {
            try {
                UI.showLoading(document.getElementById('servicesList'));
                const services = await api.getServices();
                displayServices(services);
            } catch (error) {
                console.error('Erro ao carregar serviços:', error);
                document.getElementById('servicesList').innerHTML =
                    '<div class="alert alert-error">Erro ao carregar serviços. Verifique sua conexão.</div>';
                UI.showError('Erro ao carregar serviços: ' + error.message);
            }
        }

        // Exibir serviços
        function displayServices(services) {
            const container = document.getElementById('servicesList');

            if (services.length === 0) {
                container.innerHTML = '<p class="text-center">Nenhum serviço encontrado.</p>';
                return;
            }

            container.innerHTML = `
                <table class="table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Nome</th>
                            <th>Descrição</th>
                            <th>Preço</th>
                            <th>Duração</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${services.map(service => `
                            <tr>
                                <td>#${service.id}</td>
                                <td>${service.nome}</td>
                                <td>${service.descricao || 'N/A'}</td>
                                <td>${Formatter.currency(service.preco)}</td>
                                <td>${service.duracao_minutos ? service.duracao_minutos + ' min' : 'N/A'}</td>
                                <td>
                                    <button class="btn btn-sm btn-secondary" onclick="openServiceModal(${service.id})">Editar</button>
                                    <button class="btn btn-sm btn-danger" onclick="deleteService(${service.id})">Excluir</button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        // Excluir serviço
        async function deleteService(serviceId) {
            if (!confirm('Tem certeza que deseja excluir este serviço?')) return;

            try {
                await api.deleteService(serviceId);
                UI.showSuccess('Serviço excluído com sucesso!');
                loadServices();
            } catch (error) {
                console.error('Erro ao excluir serviço:', error);
                UI.showError('Erro ao excluir serviço.');
            }
        }

        // Carregar profissionais
        async function loadProfessionals() {
            try {
                UI.showLoading(document.getElementById('professionalsList'));
                const professionals = await api.getProfessionals();
                displayProfessionals(professionals);
            } catch (error) {
                console.error('Erro ao carregar profissionais:', error);
                document.getElementById('professionalsList').innerHTML =
                    '<div class="alert alert-error">Erro ao carregar profissionais. Verifique sua conexão.</div>';
                UI.showError('Erro ao carregar profissionais: ' + error.message);
            }
        }

        // Exibir profissionais
        function displayProfessionals(professionals) {
            const container = document.getElementById('professionalsList');

            if (professionals.length === 0) {
                container.innerHTML = '<p class="text-center">Nenhum profissional encontrado.</p>';
                return;
            }

            container.innerHTML = `
                <table class="table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Nome</th>
                            <th>E-mail</th>
                            <th>Telefone</th>
                            <th>Especialidade</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${professionals.map(prof => `
                            <tr>
                                <td>#${prof.id}</td>
                                <td>${prof.nome}</td>
                                <td>${prof.email}</td>
                                <td>${prof.telefone}</td>
                                <td>${prof.especialidade || 'N/A'}</td>
                                <td>
                                    <button class="btn btn-sm btn-secondary" onclick="openProfessionalModal(${prof.id})">Editar</button>
                                    <button class="btn btn-sm btn-danger" onclick="deleteProfessional(${prof.id})">Excluir</button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        // Excluir profissional
        async function deleteProfessional(professionalId) {
            if (!confirm('Tem certeza que deseja excluir este profissional?')) return;

            try {
                await api.deleteProfessional(professionalId);
                UI.showSuccess('Profissional excluído com sucesso!');
                loadProfessionals();
            } catch (error) {
                console.error('Erro ao excluir profissional:', error);
                UI.showError('Erro ao excluir profissional.');
            }
        }

        // ============ ASSOCIAÇÃO DE SERVIÇOS A PROFISSIONAIS ============

        // Carregar associações de serviços para um profissional
        async function loadServiceAssociations(professionalId) {
            try {
                console.log(`[ASSOCIATIONS] Carregando associações para profissional ${professionalId}`);

                // Buscar serviços associados ao profissional
                const associatedServices = await api.request(`/professionals/${professionalId}/services`);
                console.log('[ASSOCIATIONS] Serviços associados:', associatedServices);

                // Buscar todos os serviços disponíveis
                const allServices = await api.getServices();
                console.log('[ASSOCIATIONS] Todos os serviços:', allServices);

                // Preencher checkboxes
                const servicesCheckboxes = document.getElementById('servicesCheckboxes');
                if (!servicesCheckboxes) {
                    console.error('[ASSOCIATIONS] Container servicesCheckboxes não encontrado');
                    return;
                }

                // Criar HTML dos checkboxes
                const checkboxesHtml = allServices.map(service => {
                    const isAssociated = associatedServices.some(assoc => assoc.id === service.id);
                    return `
                        <div class="form-check">
                            <input type="checkbox"
                                   id="service_${service.id}"
                                   value="${service.id}"
                                   class="form-check-input"
                                   ${isAssociated ? 'checked' : ''}>
                            <label for="service_${service.id}" class="form-check-label">
                                <strong>${service.nome}</strong>
                                ${service.descricao ? `<br><small class="text-muted">${service.descricao}</small>` : ''}
                                <br><small class="text-muted">Preço: ${Formatter.currency(service.preco)}</small>
                            </label>
                        </div>
                    `;
                }).join('');

                servicesCheckboxes.innerHTML = checkboxesHtml;
                console.log('[ASSOCIATIONS] Checkboxes criados com sucesso');

            } catch (error) {
                console.error('[ASSOCIATIONS] Erro ao carregar associações:', error);
                UI.showError('Erro ao carregar associações de serviços.');
            }
        }

        // Manipular seleção de profissional
        async function handleProfessionalSelect(event) {
            const professionalId = event.target.value;
            console.log(`[ASSOCIATIONS] Profissional selecionado: ${professionalId}`);

            const servicesAssociation = document.getElementById('servicesAssociation');

            if (!professionalId) {
                // Nenhum profissional selecionado
                servicesAssociation.style.display = 'none';
                return;
            }

            // Mostrar seção de associação e carregar dados
            servicesAssociation.style.display = 'block';
            await loadServiceAssociations(professionalId);
        }

        // Salvar associações de serviços
        async function handleSaveServiceAssociation(event) {
            event.preventDefault();

            const professionalSelect = document.getElementById('professionalSelect');
            const professionalId = professionalSelect.value;

            if (!professionalId) {
                UI.showError('Selecione um profissional primeiro.');
                return;
            }

            try {
                console.log(`[ASSOCIATIONS] Salvando associações para profissional ${professionalId}`);

                // Coletar serviços selecionados
                const selectedServices = [];
                const checkboxes = document.querySelectorAll('#servicesCheckboxes input[type="checkbox"]:checked');

                checkboxes.forEach(checkbox => {
                    selectedServices.push(parseInt(checkbox.value));
                });

                console.log('[ASSOCIATIONS] Serviços selecionados:', selectedServices);

                // Enviar associações para o backend
                const result = await api.request(`/professionals/${professionalId}/services`, {
                    method: 'POST',
                    body: JSON.stringify({ service_ids: selectedServices })
                });

                console.log('[ASSOCIATIONS] Resultado da associação:', result);
                UI.showSuccess('Associações de serviços salvas com sucesso!');

                // Recarregar associações para confirmar
                await loadServiceAssociations(professionalId);

            } catch (error) {
                console.error('[ASSOCIATIONS] Erro ao salvar associações:', error);
                UI.showError('Erro ao salvar associações de serviços.');
            }
        }

        // Cancelar associação (limpar seleção)
        function handleCancelServiceAssociation() {
            const professionalSelect = document.getElementById('professionalSelect');
            const servicesAssociation = document.getElementById('servicesAssociation');

            // Resetar select
            professionalSelect.value = '';

            // Esconder seção
            servicesAssociation.style.display = 'none';

            console.log('[ASSOCIATIONS] Associação cancelada');
        }

        // Modais CRUD
        function openClientModal(clientId = null) {
            currentEditId = clientId;
            currentEditType = 'client';
            
            document.getElementById('modalTitle').textContent = clientId ? 'Editar Cliente' : 'Adicionar Cliente';
            document.getElementById('modalBody').innerHTML = `
                <div class="form-group">
                    <label class="form-label">Nome</label>
                    <input type="text" id="modalName" class="form-control" required>
                </div>
                <div class="form-group">
                    <label class="form-label">E-mail</label>
                    <input type="email" id="modalEmail" class="form-control" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Telefone</label>
                    <input type="tel" id="modalPhone" class="form-control" required>
                </div>
                ${!clientId ? `
                <div class="form-group">
                    <label class="form-label">Senha</label>
                    <input type="password" id="modalPassword" class="form-control" required>
                </div>
                ` : ''}
            `;
            
            // Se for edição, carregar dados
            if (clientId) {
                // Implementar carregamento dos dados do cliente
            }
            
            document.getElementById('crudModal').classList.add('show');
        }

        function openServiceModal(serviceId = null) {
            currentEditId = serviceId;
            currentEditType = 'service';

            document.getElementById('modalTitle').textContent = serviceId ? 'Editar Serviço' : 'Adicionar Serviço';
            document.getElementById('modalBody').innerHTML = `
                <div class="form-group">
                    <label class="form-label">Nome</label>
                    <input type="text" id="modalName" class="form-control" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Descrição</label>
                    <textarea id="modalDescription" class="form-control" rows="3"></textarea>
                </div>
                <div class="grid grid-3">
                    <div class="form-group">
                        <label class="form-label">Preço</label>
                        <input type="number" id="modalPrice" class="form-control" step="0.01" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Duração (minutos)</label>
                        <input type="number" id="modalDuration" class="form-control" placeholder="Ex: 60" min="1">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Pontos de Fidelidade</label>
                        <input type="number" id="modalPoints" class="form-control" placeholder="Ex: 10" min="0" value="0">
                        <small class="text-muted">Pontos concedidos ao cliente quando o serviço é concluído</small>
                    </div>
                </div>
            `;

            document.getElementById('crudModal').classList.add('show');
        }

        function openProfessionalModal(professionalId = null) {
            currentEditId = professionalId;
            currentEditType = 'professional';

            document.getElementById('modalTitle').textContent = professionalId ? 'Editar Profissional' : 'Adicionar Profissional';
            document.getElementById('modalBody').innerHTML = `
                <div class="form-group">
                    <label class="form-label">Nome</label>
                    <input type="text" id="modalName" class="form-control" required>
                </div>
                <div class="form-group">
                    <label class="form-label">E-mail</label>
                    <input type="email" id="modalEmail" class="form-control" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Telefone</label>
                    <input type="tel" id="modalPhone" class="form-control" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Especialidade</label>
                    <input type="text" id="modalSpecialty" class="form-control">
                </div>
                <div class="form-group">
                    <label class="form-label">Foto do Profissional</label>
                    <input type="file" id="modalPhoto" class="form-control" accept="image/*">
                    <small class="text-muted">Formato: JPG, PNG. Tamanho máximo: 5MB</small>
                </div>
            `;

            document.getElementById('crudModal').classList.add('show');
        }

        function closeModal() {
            document.getElementById('crudModal').classList.remove('show');
            document.getElementById('crudForm').reset();
            currentEditId = null;
            currentEditType = null;
        }

        // Processar submit do CRUD
        async function handleCrudSubmit(event) {
            event.preventDefault();

            console.log('[CRUD] Iniciando submit, currentUser:', currentUser);
            console.log('[CRUD] currentEditType:', currentEditType);

            // Garantir que temos informações do usuário
            if (!currentUser) {
                console.log('[CRUD] currentUser não definido, carregando...');
                try {
                    const userInfo = await api.request('/auth/me');
                    currentUser = userInfo;
                    console.log('[CRUD] currentUser carregado:', currentUser);
                } catch (error) {
                    console.error('[CRUD] Erro ao carregar currentUser:', error);
                    UI.showError('Erro ao obter informações do usuário');
                    return;
                }
            }

            try {
                let data = {};
                let result;

                switch(currentEditType) {
                    case 'client':
                        data = {
                            nome: document.getElementById('modalName').value,
                            email: document.getElementById('modalEmail').value,
                            telefone: document.getElementById('modalPhone').value,
                            salon_id: currentUser ? currentUser.id : 1 // ID do salão do usuário logado
                        };
                        if (!currentEditId) {
                            data.senha = document.getElementById('modalPassword').value;
                            result = await api.createClient(data);
                        } else {
                            result = await api.updateClient(currentEditId, data);
                        }
                        loadClients();
                        break;

                    case 'service':
                        const serviceSalonId = currentUser ? parseInt(currentUser.id) : 1;
                        console.log('[CRUD] Criando serviço com salon_id:', serviceSalonId, 'currentUser:', currentUser);
                        data = {
                            nome: document.getElementById('modalName').value,
                            descricao: document.getElementById('modalDescription').value,
                            preco: parseFloat(document.getElementById('modalPrice').value),
                            duracao_minutos: parseInt(document.getElementById('modalDuration').value) || null,
                            salon_id: serviceSalonId
                        };
                        console.log('[CRUD] Dados do serviço:', data);
                        if (!currentEditId) {
                            result = await api.createService(data);
                        } else {
                            result = await api.updateService(currentEditId, data);
                        }
                        loadServices();
                        break;

                    case 'professional':
                        const photoInput = document.getElementById('modalPhoto');
                        const photoFile = photoInput ? photoInput.files[0] : null;

                        if (photoFile) {
                            // Usar FormData para upload de arquivo
                            const formData = new FormData();
                            formData.append('nome', document.getElementById('modalName').value);
                            formData.append('email', document.getElementById('modalEmail').value);
                            formData.append('telefone', document.getElementById('modalPhone').value);
                            formData.append('especialidade', document.getElementById('modalSpecialty').value);
                            formData.append('foto', photoFile);

                            if (!currentEditId) {
                                result = await api.createProfessionalWithPhoto(formData);
                            } else {
                                // Para edição, ainda não implementado com foto
                                result = await api.updateProfessional(currentEditId, {
                                    nome: document.getElementById('modalName').value,
                                    email: document.getElementById('modalEmail').value,
                                    telefone: document.getElementById('modalPhone').value,
                                    especialidade: document.getElementById('modalSpecialty').value
                                });
                            }
                        } else {
                            // Sem foto, usar JSON normal
                            data = {
                                nome: document.getElementById('modalName').value,
                                email: document.getElementById('modalEmail').value,
                                telefone: document.getElementById('modalPhone').value,
                                especialidade: document.getElementById('modalSpecialty').value,
                                salon_id: currentUser ? currentUser.id : 1, // ID do salão do usuário logado
                                ativo: true
                            };
                            if (!currentEditId) {
                                result = await api.createProfessional(data);
                            } else {
                                result = await api.updateProfessional(currentEditId, data);
                            }
                        }
                        loadProfessionals();
                        break;
                }

                UI.showSuccess(currentEditId ? 'Atualizado com sucesso!' : 'Criado com sucesso!');
                closeModal();

            } catch (error) {
                console.error('Erro no CRUD:', error);
                UI.showError(error.message || 'Erro ao salvar dados.');
            }
        }

        // Relatórios
        async function generateRevenueReport() {
            try {
                const period = document.getElementById('revenueReportPeriod').value;
                let days = 7;
                if (period === 'weekly') days = 7;
                else if (period === 'monthly') days = 30;
                else if (period === 'daily') days = 1;

                const result = await api.getRevenueReport(days);

                // Verificar se há dados ou mensagem de erro
                if (result.success === false) {
                    document.getElementById('revenueReportResult').innerHTML = `
                        <div class="alert alert-info">
                            <strong>Relatório de Faturamento</strong><br>
                            ${result.message}
                        </div>
                    `;
                    return;
                }

                // Se há dados, calcular total e exibir
                const total = result.data.reduce((sum, item) => sum + item.faturamento, 0);

                document.getElementById('revenueReportResult').innerHTML = `
                    <div class="alert alert-success">
                        <strong>Faturamento ${period}:</strong> ${Formatter.currency(total)}
                    </div>
                `;
            } catch (error) {
                console.error('Erro no relatório:', error);
                document.getElementById('revenueReportResult').innerHTML =
                    '<div class="alert alert-error">Erro ao gerar relatório: ' + error.message + '</div>';
            }
        }

        async function generateNewClientsReport() {
            try {
                const period = document.getElementById('newClientsReportPeriod').value;
                const result = await api.getNewClientsReport(period);

                // Verificar se há dados ou mensagem de erro
                if (result.success === false) {
                    document.getElementById('newClientsReportResult').innerHTML = `
                        <div class="alert alert-info">
                            <strong>Relatório de Novos Clientes</strong><br>
                            ${result.message}
                        </div>
                    `;
                    return;
                }

                // Se há dados, calcular total e exibir
                const total = result.data.reduce((sum, item) => sum + item.novos_clientes, 0);

                document.getElementById('newClientsReportResult').innerHTML = `
                    <div class="alert alert-success">
                        <strong>Novos clientes (${period}):</strong> ${total}
                    </div>
                `;
            } catch (error) {
                console.error('Erro no relatório:', error);
                document.getElementById('newClientsReportResult').innerHTML =
                    '<div class="alert alert-error">Erro ao gerar relatório: ' + error.message + '</div>';
            }
        }

        async function generatePerformanceReport() {
            try {
                const result = await api.getPerformanceReport();

                // Verificar se há dados ou mensagem de erro
                if (result.success === false) {
                    document.getElementById('performanceReportResult').innerHTML = `
                        <div class="alert alert-info">
                            <strong>Relatório de Performance</strong><br>
                            ${result.message}
                        </div>
                    `;
                    return;
                }

                // Se há dados, exibir relatório completo
                const data = result.data;
                let html = '<div class="alert alert-success"><strong>Performance do Estabelecimento:</strong><br>';
                html += `Agendamentos hoje: ${data.agendamentos_hoje}<br>`;
                html += `Faturamento mensal: ${Formatter.currency(data.faturamento_mensal)}<br>`;
                html += `Novos clientes este mês: ${data.novos_clientes_mes}<br>`;
                html += `Taxa de ocupação estimada: ${data.taxa_ocupacao_estimada.toFixed(1)}%`;
                html += '</div>';

                document.getElementById('performanceReportResult').innerHTML = html;
            } catch (error) {
                console.error('Erro no relatório:', error);
                document.getElementById('performanceReportResult').innerHTML =
                    '<div class="alert alert-error">Erro ao gerar relatório: ' + error.message + '</div>';
            }
        }

        // Utilitários
        function getStatusClass(status) {
            // Handle both enum string format and direct values
            const normalizedStatus = status.toLowerCase().replace('statusagendamento.', '');
            switch(normalizedStatus) {
                case 'confirmado':
                case 'confirmed': return 'badge-success';
                case 'concluido':
                case 'completed': return 'badge-info';
                case 'cancelado':
                case 'cancelled': return 'badge-danger';
                case 'nao_compareceu':
                case 'no_show': return 'badge-dark';
                case 'agendado':
                case 'pending': return 'badge-warning';
                default: return 'badge-warning';
            }
        }

        function getStatusText(status) {
            // Handle both enum string format and direct values
            const normalizedStatus = status.toLowerCase().replace('statusagendamento.', '');
            switch(normalizedStatus) {
                case 'agendado':
                case 'pending': return 'Agendado';
                case 'confirmado':
                case 'confirmed': return 'Confirmado';
                case 'concluido':
                case 'completed': return 'Concluído';
                case 'cancelado':
                case 'cancelled': return 'Cancelado';
                case 'nao_compareceu':
                case 'no_show': return 'Não Compareceu';
                default: return status;
            }
        }

        // ============ SISTEMA DE MONITORAMENTO DE PRESENÇA ============

        // Variáveis globais do sistema de presença
        let presenceCheckInterval = null;
        let activeNotifications = new Map(); // Map<appointmentId, notificationData>
        let presenceModalTimeout = null;

        // Classe para gerenciar notificações
        class NotificationManager {
            constructor() {
                this.container = document.getElementById('notificationsContainer');
                this.notifications = new Map();
            }

            show(title, message, type = 'info', actions = null, duration = null) {
                const notificationId = Date.now() + Math.random();

                const notification = document.createElement('div');
                notification.className = `notification ${type}`;
                notification.id = `notification-${notificationId}`;

                let actionsHtml = '';
                if (actions) {
                    actionsHtml = `
                        <div class="notification-actions">
                            ${actions.map(action =>
                                `<button class="btn btn-${action.type}" onclick="${action.callback}">${action.label}</button>`
                            ).join('')}
                        </div>
                    `;
                }

                notification.innerHTML = `
                    <div class="notification-header">
                        <h4 class="notification-title">${title}</h4>
                        <span class="notification-time">${new Date().toLocaleTimeString('pt-BR')}</span>
                    </div>
                    <div class="notification-message">${message}</div>
                    ${actionsHtml}
                `;

                this.container.appendChild(notification);

                // Auto-remover após duração especificada
                if (duration) {
                    setTimeout(() => this.remove(notificationId), duration);
                }

                // Tocar som de notificação se disponível
                this.playNotificationSound();

                return notificationId;
            }

            remove(notificationId) {
                const notification = document.getElementById(`notification-${notificationId}`);
                if (notification) {
                    notification.style.animation = 'slideOutRight 0.3s ease-out';
                    setTimeout(() => {
                        if (notification.parentNode) {
                            notification.parentNode.removeChild(notification);
                        }
                    }, 300);
                }
                this.notifications.delete(notificationId);
            }

            playNotificationSound() {
                // Tentar tocar um beep simples
                try {
                    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();

                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);

                    oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
                    oscillator.frequency.setValueAtTime(600, audioContext.currentTime + 0.1);

                    gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);

                    oscillator.start(audioContext.currentTime);
                    oscillator.stop(audioContext.currentTime + 0.3);
                } catch (e) {
                    // Silently fail if audio is not available
                    console.log('Audio notification not available');
                }
            }
        }

        // Instância global do gerenciador de notificações
        const notificationManager = new NotificationManager();

        // Sistema de monitoramento de presença
        class PresenceMonitor {
            constructor() {
                this.checkInterval = 30000; // Verificar a cada 30 segundos
                this.gracePeriod = 20 * 60 * 1000; // 20 minutos em ms
                this.notificationTimeout = 5 * 60 * 1000; // 5 minutos para resposta
                this.cleanupInterval = 24 * 60 * 60 * 1000; // Limpeza diária (24 horas)
                this.intervalId = null;
                this.cleanupId = null;
                this.lastCheck = null;
            }

            start() {
                console.log('[PRESENCE] Iniciando monitoramento de presença...');
                this.checkPresence();
                this.intervalId = setInterval(() => this.checkPresence(), this.checkInterval);

                // Iniciar limpeza automática diária
                this.scheduleCleanup();
            }

            stop() {
                if (this.intervalId) {
                    clearInterval(this.intervalId);
                    this.intervalId = null;
                }
                if (this.cleanupId) {
                    clearTimeout(this.cleanupId);
                    this.cleanupId = null;
                }
            }

            scheduleCleanup() {
                // Executar limpeza imediatamente e depois diariamente
                this.performCleanup();

                // Agendar próxima limpeza em 24 horas
                this.cleanupId = setTimeout(() => {
                    this.scheduleCleanup();
                }, this.cleanupInterval);
            }

            async performCleanup() {
                try {
                    console.log('[PRESENCE] Executando limpeza automatica de agendamentos antigos...');

                    // Chamar endpoint de limpeza (se existir) ou executar localmente
                    // Por enquanto, apenas log - pode ser integrado com backend depois
                    console.log('[PRESENCE] Limpeza de nao_compareceu seria executada aqui');

                } catch (error) {
                    console.error('[PRESENCE] Erro na limpeza automatica:', error);
                }
            }

            async checkPresence() {
                try {
                    const now = new Date();
                    console.log(`[PRESENCE] Verificando presenças às ${now.toLocaleTimeString()}`);

                    // Buscar agendamentos próximos (próximas 2 horas)
                    const upcomingAppointments = await this.getUpcomingAppointments();

                    for (const appointment of upcomingAppointments) {
                        const appointmentTime = new Date(appointment.data_hora);
                        const timeDiff = now - appointmentTime;

                        // Se passou mais de 20 minutos do horário agendado
                        if (timeDiff > this.gracePeriod) {
                            // Verificar se já foi notificado
                            if (!activeNotifications.has(appointment.id)) {
                                this.notifyPresenceRequired(appointment);
                            }
                        }
                    }

                    this.lastCheck = now;
                } catch (error) {
                    console.error('[PRESENCE] Erro ao verificar presença:', error);
                }
            }

            async getUpcomingAppointments() {
                try {
                    const appointments = await api.getAppointments();
                    const now = new Date();
                    const twoHoursFromNow = new Date(now.getTime() + 2 * 60 * 60 * 1000);

                    return appointments.filter(apt => {
                        const aptTime = new Date(apt.data_hora);
                        return aptTime >= now && aptTime <= twoHoursFromNow &&
                               apt.status === 'agendado';
                    });
                } catch (error) {
                    console.error('[PRESENCE] Erro ao buscar agendamentos próximos:', error);
                    return [];
                }
            }

            notifyPresenceRequired(appointment) {
                const appointmentTime = new Date(appointment.data_hora);
                const now = new Date();
                const delayMinutes = Math.floor((now - appointmentTime) / (1000 * 60));

                const title = 'Confirmação de Presença Necessária';
                const message = `
                    <strong>${appointment.cliente?.nome || 'Cliente'}</strong> tem agendamento para
                    <strong>${appointment.servico?.nome || 'Serviço'}</strong> às
                    <strong>${appointmentTime.toLocaleTimeString('pt-BR', {hour: '2-digit', minute: '2-digit'})}</strong>.<br>
                    Já se passaram <strong>${delayMinutes} minutos</strong> do horário agendado.
                `;

                // Mostrar notificação
                const notificationId = notificationManager.show(
                    title,
                    message,
                    'attention',
                    [
                        {
                            label: '✅ Cliente Apareceu',
                            type: 'success',
                            callback: `presenceMonitor.confirmPresence(${appointment.id})`
                        },
                        {
                            label: '❌ Não Apareceu',
                            type: 'danger',
                            callback: `presenceMonitor.denyPresence(${appointment.id})`
                        }
                    ]
                );

                // Registrar notificação ativa
                activeNotifications.set(appointment.id, {
                    notificationId,
                    appointment,
                    timestamp: Date.now(),
                    timeoutId: setTimeout(() => {
                        this.autoDenyPresence(appointment.id);
                    }, this.notificationTimeout)
                });

                // Mostrar modal de presença
                this.showPresenceModal(appointment);
            }

            showPresenceModal(appointment) {
                const modal = document.getElementById('presenceModal');
                const modalBody = document.getElementById('presenceModalBody');
                const confirmBtn = document.getElementById('confirmPresenceBtn');
                const denyBtn = document.getElementById('denyPresenceBtn');
                const appointmentTime = new Date(appointment.data_hora);

                // Definir appointmentId nos botões
                confirmBtn.dataset.appointmentId = appointment.id;
                denyBtn.dataset.appointmentId = appointment.id;

                modalBody.innerHTML = `
                    <div class="presence-info">
                        <h4>Cliente: ${appointment.cliente?.nome || 'Cliente'}</h4>
                        <p><strong>Serviço:</strong> ${appointment.servico?.nome || 'Serviço'}</p>
                        <p><strong>Horário agendado:</strong> ${appointmentTime.toLocaleString('pt-BR')}</p>
                        <p><strong>Profissional:</strong> ${appointment.profissional?.nome || 'Não especificado'}</p>
                    </div>
                    <div class="presence-timer" id="presenceTimer">
                        Tempo restante: 5:00
                    </div>
                `;

                modal.classList.add('show');

                // Iniciar countdown
                this.startPresenceCountdown(appointment.id);
            }

            startPresenceCountdown(appointmentId) {
                let timeLeft = this.notificationTimeout / 1000; // em segundos
                const timerElement = document.getElementById('presenceTimer');

                const countdownInterval = setInterval(() => {
                    const minutes = Math.floor(timeLeft / 60);
                    const seconds = timeLeft % 60;
                    timerElement.textContent = `Tempo restante: ${minutes}:${seconds.toString().padStart(2, '0')}`;

                    timeLeft--;

                    if (timeLeft < 0) {
                        clearInterval(countdownInterval);
                        this.autoDenyPresence(appointmentId);
                    }
                }, 1000);

                // Armazenar interval para limpar depois
                if (activeNotifications.has(appointmentId)) {
                    activeNotifications.get(appointmentId).countdownInterval = countdownInterval;
                }
            }

            async confirmPresence(appointmentId) {
                try {
                    console.log(`[PRESENCE] Confirmando presença do agendamento ${appointmentId}`);

                    // Atualizar status para 'confirmado' ou manter 'agendado'
                    await api.updateAppointmentStatus(appointmentId, 'confirmado');

                    // Limpar notificações
                    this.clearNotification(appointmentId);

                    // Fechar modal
                    document.getElementById('presenceModal').classList.remove('show');

                    // Mostrar sucesso
                    notificationManager.show(
                        'Presença Confirmada',
                        'Cliente confirmado como presente.',
                        'success',
                        null,
                        3000
                    );

                    // Recarregar dashboard
                    loadDashboard();

                } catch (error) {
                    console.error('[PRESENCE] Erro ao confirmar presença:', error);
                    UI.showError('Erro ao confirmar presença do cliente');
                }
            }

            async denyPresence(appointmentId) {
                try {
                    console.log(`[PRESENCE] Registrando ausência do agendamento ${appointmentId}`);

                    // Atualizar status para 'nao_compareceu'
                    await api.updateAppointmentStatus(appointmentId, 'nao_compareceu');

                    // Limpar notificações
                    this.clearNotification(appointmentId);

                    // Fechar modal
                    document.getElementById('presenceModal').classList.remove('show');

                    // Mostrar informação
                    notificationManager.show(
                        'Ausência Registrada',
                        'Cliente registrado como não compareceu. Agendamento mantido no histórico.',
                        'warning',
                        null,
                        5000
                    );

                    // Recarregar dashboard
                    loadDashboard();

                } catch (error) {
                    console.error('[PRESENCE] Erro ao registrar ausência:', error);
                    UI.showError('Erro ao registrar ausência do cliente');
                }
            }

            async autoDenyPresence(appointmentId) {
                console.log(`[PRESENCE] Timeout - cancelando automaticamente agendamento ${appointmentId}`);

                // Fechar modal se estiver aberto
                document.getElementById('presenceModal').classList.remove('show');

                // Cancelar automaticamente
                await this.denyPresence(appointmentId);
            }

            clearNotification(appointmentId) {
                const notificationData = activeNotifications.get(appointmentId);
                if (notificationData) {
                    // Limpar timeout
                    if (notificationData.timeoutId) {
                        clearTimeout(notificationData.timeoutId);
                    }

                    // Limpar countdown
                    if (notificationData.countdownInterval) {
                        clearInterval(notificationData.countdownInterval);
                    }

                    // Remover notificação
                    notificationManager.remove(notificationData.notificationId);

                    // Remover do mapa
                    activeNotifications.delete(appointmentId);
                }
            }
        }

        // Instância global do monitor de presença
        const presenceMonitor = new PresenceMonitor();

        // ============ GERENCIAMENTO DE SUB-ABAS ============

        let currentSubTab = 'manage';

        // Alternar entre sub-abas
        function switchSubTab(subTabName) {
            console.log(`🔄 Trocando para sub-aba: ${subTabName}`);

            // Esconder todas as sub-abas
            const allSubTabs = document.querySelectorAll('.sub-tab-content');
            allSubTabs.forEach(subTab => {
                subTab.style.display = 'none';
                subTab.classList.remove('active');
            });

            // Remover classe active de todos os botões
            const allSubTabButtons = document.querySelectorAll('.sub-tab-btn');
            allSubTabButtons.forEach(btn => {
                btn.className = 'btn btn-outline sub-tab-btn';
            });

            // Ativar botão clicado
            const activeButton = document.querySelector(`[data-sub-tab="${subTabName}"]`);
            if (activeButton) {
                activeButton.className = 'btn btn-primary sub-tab-btn active';
            }

            // Mostrar sub-aba selecionada - lógica específica por aba
            let targetId;
            if (currentTab === 'professionals') {
                if (subTabName === 'manage') {
                    targetId = 'manageProfessionalsSubTab';
                } else if (subTabName === 'services') {
                    targetId = 'associateServicesSubTab';
                }
            } else {
                targetId = subTabName + 'AppointmentsSubTab';
            }

            const targetSubTab = document.getElementById(targetId);
            if (targetSubTab) {
                targetSubTab.style.display = 'block';
                targetSubTab.classList.add('active');
                console.log(`🎉 Sub-aba ${subTabName} ativada`);
            }

            currentSubTab = subTabName;

            // Carregar dados da sub-aba se necessário
            if (subTabName === 'history') {
                loadAppointmentsHistory();
            } else if (subTabName === 'manage') {
                if (currentTab === 'professionals') {
                    loadProfessionals();
                } else {
                    loadAppointments();
                }
            } else if (subTabName === 'services') {
                // Para profissionais, carregar associações de serviços
                loadServiceAssociations();
            }
        }

        // ============ HISTÓRICO DE AGENDAMENTOS ============

        // Carregar histórico de agendamentos
        async function loadAppointmentsHistory() {
            try {
                console.log('[HISTORY] Iniciando carregamento do histórico...');
                UI.showLoading(document.getElementById('appointmentsHistoryList'));

                const appointments = await api.getAppointments();
                console.log(`[HISTORY] Recebidos ${appointments.length} agendamentos para histórico`);

                // Ordenar por data decrescente (mais recente primeiro)
                appointments.sort((a, b) => new Date(b.data_hora) - new Date(a.data_hora));

                displayAppointmentsHistory(appointments);
                console.log('[HISTORY] Histórico exibido com sucesso');
            } catch (error) {
                console.error('[HISTORY] Erro ao carregar histórico:', error);
                document.getElementById('appointmentsHistoryList').innerHTML =
                    '<div class="alert alert-error">Erro ao carregar histórico. Verifique sua conexão.</div>';
                UI.showError('Erro ao carregar histórico: ' + error.message);
            }
        }

        // Exibir histórico de agendamentos
        function displayAppointmentsHistory(appointments) {
            const container = document.getElementById('appointmentsHistoryList');

            if (!appointments || appointments.length === 0) {
                container.innerHTML = '<p class="text-center" style="color: #666; padding: 2rem;">📅 Nenhum agendamento encontrado no histórico.</p>';
                return;
            }

            container.innerHTML = `
                <table class="table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Cliente</th>
                            <th>Serviço</th>
                            <th>Profissional</th>
                            <th>Data e Hora</th>
                            <th>Status</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${appointments.map(apt => `
                            <tr>
                                <td>#${apt.id}</td>
                                <td>${apt.cliente ? apt.cliente.nome : 'Cliente removido'}</td>
                                <td>${apt.servico ? apt.servico.nome : 'N/A'}</td>
                                <td>${apt.profissional ? apt.profissional.nome : 'N/A'}</td>
                                <td>${Formatter.datetime(apt.data_hora)}</td>
                                <td><span class="badge ${getStatusClass(apt.status)}">${getStatusText(apt.status)}</span></td>
                                <td>
                                    <button class="btn btn-sm btn-info" onclick="viewAppointmentDetails(${apt.id})">
                                        👁️ Ver Detalhes
                                    </button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        // Aplicar filtros do histórico
        function applyHistoryFilters() {
            const statusFilter = document.getElementById('historyStatusFilter').value;
            const dateFrom = document.getElementById('historyDateFrom').value;
            const dateTo = document.getElementById('historyDateTo').value;
            const clientFilter = document.getElementById('historyClientFilter').value.toLowerCase();

            console.log('[FILTERS] Aplicando filtros:', { statusFilter, dateFrom, dateTo, clientFilter });

            // Recarregar dados e aplicar filtros
            loadAppointmentsHistoryWithFilters(statusFilter, dateFrom, dateTo, clientFilter);
        }

        // Carregar histórico com filtros aplicados
        async function loadAppointmentsHistoryWithFilters(statusFilter, dateFrom, dateTo, clientFilter) {
            try {
                UI.showLoading(document.getElementById('appointmentsHistoryList'));

                const appointments = await api.getAppointments();
                console.log(`[FILTERS] Aplicando filtros a ${appointments.length} agendamentos`);

                // Aplicar filtros
                let filteredAppointments = appointments.filter(apt => {
                    // Filtro de status
                    if (statusFilter && apt.status !== statusFilter) {
                        return false;
                    }

                    // Filtro de data inicial
                    if (dateFrom) {
                        const aptDate = new Date(apt.data_hora).toISOString().split('T')[0];
                        if (aptDate < dateFrom) {
                            return false;
                        }
                    }

                    // Filtro de data final
                    if (dateTo) {
                        const aptDate = new Date(apt.data_hora).toISOString().split('T')[0];
                        if (aptDate > dateTo) {
                            return false;
                        }
                    }

                    // Filtro de cliente
                    if (clientFilter) {
                        const clientName = apt.cliente ? apt.cliente.nome.toLowerCase() : '';
                        if (!clientName.includes(clientFilter)) {
                            return false;
                        }
                    }

                    return true;
                });

                // Ordenar por data decrescente
                filteredAppointments.sort((a, b) => new Date(b.data_hora) - new Date(a.data_hora));

                console.log(`[FILTERS] ${filteredAppointments.length} agendamentos após filtros`);
                displayAppointmentsHistory(filteredAppointments);
            } catch (error) {
                console.error('[FILTERS] Erro ao aplicar filtros:', error);
                UI.showError('Erro ao aplicar filtros: ' + error.message);
            }
        }

        // Limpar filtros do histórico
        function clearHistoryFilters() {
            document.getElementById('historyStatusFilter').value = '';
            document.getElementById('historyDateFrom').value = '';
            document.getElementById('historyDateTo').value = '';
            document.getElementById('historyClientFilter').value = '';

            console.log('[FILTERS] Filtros limpos');
            loadAppointmentsHistory();
        }

        // Ver detalhes do agendamento
        async function viewAppointmentDetails(appointmentId) {
            console.log(`[DETAILS] Buscando detalhes do agendamento ${appointmentId}`);

            try {
                // Buscar dados específicos do agendamento
                const appointment = await api.request(`${API_CONFIG.ENDPOINTS.APPOINTMENTS}${appointmentId}`);
                console.log('[DETAILS] Dados recebidos:', appointment);

                // Construir HTML dos detalhes
                const detailsHtml = `
                    <div class="appointment-details">
                        <div class="detail-section">
                            <h4>📋 Informações Gerais</h4>
                            <div class="detail-grid">
                                <div class="detail-item">
                                    <strong>ID do Agendamento:</strong> #${appointment.id}
                                </div>
                                <div class="detail-item">
                                    <strong>Status:</strong>
                                    <span class="badge ${getStatusClass(appointment.status)}">${getStatusText(appointment.status)}</span>
                                </div>
                                <div class="detail-item">
                                    <strong>Data e Hora:</strong> ${Formatter.datetime(appointment.data_hora)}
                                </div>
                                <div class="detail-item">
                                    <strong>Valor:</strong> ${Formatter.currency(appointment.valor)}
                                </div>
                            </div>
                        </div>

                        <div class="detail-section">
                            <h4>👤 Cliente</h4>
                            <div class="detail-grid">
                                <div class="detail-item">
                                    <strong>Nome:</strong> ${appointment.cliente ? appointment.cliente.nome : 'Cliente removido'}
                                </div>
                                ${appointment.cliente ? `
                                <div class="detail-item">
                                    <strong>E-mail:</strong> ${appointment.cliente.email || 'Não informado'}
                                </div>
                                <div class="detail-item">
                                    <strong>Telefone:</strong> ${appointment.cliente.telefone || 'Não informado'}
                                </div>
                                <div class="detail-item">
                                    <strong>Pontos de Fidelidade:</strong> ${appointment.cliente.pontos_fidelidade || 0}
                                </div>
                                ` : ''}
                            </div>
                        </div>

                        <div class="detail-section">
                            <h4>💇 Serviço</h4>
                            <div class="detail-grid">
                                <div class="detail-item">
                                    <strong>Nome:</strong> ${appointment.servico ? appointment.servico.nome : 'Serviço removido'}
                                </div>
                                ${appointment.servico ? `
                                <div class="detail-item">
                                    <strong>Descrição:</strong> ${appointment.servico.descricao || 'Sem descrição'}
                                </div>
                                <div class="detail-item">
                                    <strong>Duração:</strong> ${appointment.servico.duracao_minutos ? appointment.servico.duracao_minutos + ' minutos' : 'Não informado'}
                                </div>
                                <div class="detail-item">
                                    <strong>Preço Base:</strong> ${Formatter.currency(appointment.servico.preco)}
                                </div>
                                ` : ''}
                            </div>
                        </div>

                        <div class="detail-section">
                            <h4>👨‍💼 Profissional</h4>
                            <div class="detail-grid">
                                <div class="detail-item">
                                    <strong>Nome:</strong> ${appointment.profissional ? appointment.profissional.nome : 'Não atribuído'}
                                </div>
                                ${appointment.profissional ? `
                                <div class="detail-item">
                                    <strong>E-mail:</strong> ${appointment.profissional.email || 'Não informado'}
                                </div>
                                <div class="detail-item">
                                    <strong>Telefone:</strong> ${appointment.profissional.telefone || 'Não informado'}
                                </div>
                                <div class="detail-item">
                                    <strong>Especialidade:</strong> ${appointment.profissional.especialidade || 'Não informado'}
                                </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `;

                // Exibir modal com os detalhes
                document.getElementById('appointmentDetailsBody').innerHTML = detailsHtml;
                document.getElementById('appointmentDetailsModal').classList.add('show');

                console.log('[DETAILS] Detalhes exibidos com sucesso');

            } catch (error) {
                console.error('[DETAILS] Erro ao buscar detalhes:', error);
                UI.showError('Erro ao carregar detalhes do agendamento: ' + error.message);
            }
        }

        // Fechar modal de detalhes
        function closeAppointmentDetailsModal() {
            document.getElementById('appointmentDetailsModal').classList.remove('show');
            document.getElementById('appointmentDetailsBody').innerHTML = '';
        }

        // ============ GERENCIAMENTO DE PERFIL DA EMPRESA ============

        // Alternar entre sub-tabs da empresa
        function switchCompanySubTab(subTabName) {
            console.log(`[COMPANY-SUBTAB] 🔄 Iniciando troca para sub-aba: ${subTabName}`);

            // DEBUG: Verificar elementos antes da mudança
            console.log(`[COMPANY-SUBTAB] 📊 Estado atual das sub-abas antes da mudança:`);
            const allSubTabContents = document.querySelectorAll('#companyProfileTab .sub-tab-content');
            allSubTabContents.forEach(content => {
                const isVisible = content.style.display !== 'none' && content.classList.contains('active');
                console.log(`   ${content.id}: ${isVisible ? 'VISÍVEL' : 'OCULTO'}`);
            });

            // Atualizar botões - apenas os botões da aba empresa
            console.log(`[COMPANY-SUBTAB] 🎯 Atualizando botões para sub-aba: ${subTabName}`);
            const subTabButtons = document.querySelectorAll('#companyProfileTab .sub-tab-btn');
            console.log(`[COMPANY-SUBTAB] Encontrados ${subTabButtons.length} botões de sub-aba`);
            subTabButtons.forEach(btn => {
                const isActive = btn.dataset.subTab === subTabName;
                btn.className = isActive ? 'btn btn-primary sub-tab-btn active' : 'btn btn-outline sub-tab-btn';
                console.log(`   Botão ${btn.dataset.subTab}: ${isActive ? 'ATIVO' : 'INATIVO'}`);
            });

            // Mostrar/ocultar conteúdo - apenas conteúdo da aba empresa
            console.log(`[COMPANY-SUBTAB] 🔽 Escondendo todos os conteúdos de sub-aba`);
            const subTabContents = document.querySelectorAll('#companyProfileTab .sub-tab-content');
            subTabContents.forEach(content => {
                content.style.display = 'none';
                content.classList.remove('active');
                console.log(`   Escondido: ${content.id}`);
            });

            // Procurar e mostrar conteúdo alvo
            const targetId = subTabName + 'SubTab';
            console.log(`[COMPANY-SUBTAB] 🎨 Procurando conteúdo alvo: ${targetId}`);
            const targetContent = document.getElementById(targetId);
            if (targetContent) {
                console.log(`[COMPANY-SUBTAB] ✅ Conteúdo encontrado, ativando...`);
                targetContent.style.display = 'block';
                targetContent.classList.add('active');
                console.log(`[COMPANY-SUBTAB] 🎉 Sub-aba ${subTabName} ativada com sucesso`);
            } else {
                console.error(`[COMPANY-SUBTAB] ❌ Conteúdo ${targetId} NÃO encontrado no DOM`);
                console.log(`[COMPANY-SUBTAB] 📋 IDs de sub-abas disponíveis no DOM:`);
                const allContents = document.querySelectorAll('#companyProfileTab .sub-tab-content');
                allContents.forEach(content => {
                    console.log(`   - ${content.id}`);
                });
            }

            // DEBUG: Verificar estado final
            console.log(`[COMPANY-SUBTAB] 🔍 Estado final das sub-abas:`);
            const finalContents = document.querySelectorAll('#companyProfileTab .sub-tab-content');
            finalContents.forEach(content => {
                const isVisible = content.style.display !== 'none' && content.classList.contains('active');
                console.log(`   ${content.id}: ${isVisible ? 'VISÍVEL' : 'OCULTO'}`);
            });

            // Carregar dados da sub-aba se necessário
            console.log(`[COMPANY-SUBTAB] 📥 Carregando dados para sub-aba: ${subTabName}`);
            switch(subTabName) {
                case 'basic-info':
                    loadCompanyBasic();
                    break;
                case 'appearance':
                    loadCompanyAppearance();
                    break;
                case 'owner-info':
                    loadCompanyOwner();
                    break;
                case 'sharing':
                    loadCompanySharing();
                    break;
            }

            console.log(`[COMPANY-SUBTAB] ✅ Troca para sub-aba ${subTabName} concluída`);
        }

        // Alternar entre sub-tabs dos profissionais
        function switchProfessionalSubTab(subTabName) {
            console.log(`[PROFESSIONAL-SUBTAB] 🔄 Iniciando troca para sub-aba: ${subTabName}`);

            // Atualizar botões - apenas os botões da aba profissionais
            const subTabButtons = document.querySelectorAll('#professionalsTab .sub-tab-btn');
            subTabButtons.forEach(btn => {
                const isActive = btn.dataset.subTab === subTabName;
                btn.className = isActive ? 'btn btn-primary sub-tab-btn active' : 'btn btn-outline sub-tab-btn';
            });

            // Mostrar/ocultar conteúdo - apenas conteúdo da aba profissionais
            const subTabContents = document.querySelectorAll('#professionalsTab .sub-tab-content');
            subTabContents.forEach(content => {
                content.style.display = 'none';
                content.classList.remove('active');
            });

            // Procurar e mostrar conteúdo alvo
            const targetId = 'manageProfessionalsSubTab';
            if (subTabName === 'manage') {
                const targetContent = document.getElementById(targetId);
                if (targetContent) {
                    targetContent.style.display = 'block';
                    targetContent.classList.add('active');
                }
            } else if (subTabName === 'services') {
                const targetContent = document.getElementById('associateServicesSubTab');
                if (targetContent) {
                    targetContent.style.display = 'block';
                    targetContent.classList.add('active');
                    // Carregar profissionais no select quando ativar a subaba
                    loadProfessionalsForSelect();
                }
            }

            console.log(`[PROFESSIONAL-SUBTAB] ✅ Troca para sub-aba ${subTabName} concluída`);
        }

        // Carregar profissionais para o select de associação
        async function loadProfessionalsForSelect() {
            try {
                console.log('[PROFESSIONAL-SELECT] Carregando profissionais para select...');

                const professionals = await api.getProfessionals();
                const professionalSelect = document.getElementById('professionalSelect');

                if (!professionalSelect) {
                    console.error('[PROFESSIONAL-SELECT] Select não encontrado');
                    return;
                }

                // Limpar opções existentes exceto a primeira
                professionalSelect.innerHTML = '<option value="">Selecione um profissional...</option>';

                // Adicionar profissionais
                professionals.forEach(professional => {
                    const option = document.createElement('option');
                    option.value = professional.id;
                    option.textContent = `${professional.nome} (${professional.especialidade || 'Geral'})`;
                    professionalSelect.appendChild(option);
                });

                console.log(`[PROFESSIONAL-SELECT] ${professionals.length} profissionais carregados no select`);

            } catch (error) {
                console.error('[PROFESSIONAL-SELECT] Erro ao carregar profissionais:', error);
                UI.showError('Erro ao carregar lista de profissionais.');
            }
        }

        // Carregar associações de serviços (função stub para compatibilidade)
        async function loadServiceAssociations() {
            console.log('[SERVICE-ASSOCIATIONS] Função loadServiceAssociations chamada');
            // Esta função pode ser usada futuramente para carregar associações existentes
        }

        // Quando seleciona um profissional no select
        async function handleProfessionalSelect(event) {
            const professionalId = event.target.value;
            console.log(`[PROFESSIONAL-SELECT] Profissional selecionado: ${professionalId}`);

            if (!professionalId) {
                // Esconder seção de serviços se nenhum profissional selecionado
                document.getElementById('servicesAssociation').style.display = 'none';
                return;
            }

            try {
                // Carregar serviços disponíveis
                const services = await api.getServices();
                console.log(`[PROFESSIONAL-SELECT] Carregados ${services.length} serviços disponíveis`);

                // Carregar associações existentes do profissional
                const associations = await api.request(`/professionals/${professionalId}/services`);
                const associatedServiceIds = associations.services.map(s => s.id);
                console.log(`[PROFESSIONAL-SELECT] Profissional tem ${associatedServiceIds.length} associações`);

                // Gerar checkboxes
                const checkboxesContainer = document.getElementById('servicesCheckboxes');
                checkboxesContainer.innerHTML = '';

                services.forEach(service => {
                    const isChecked = associatedServiceIds.includes(service.id);

                    const checkboxDiv = document.createElement('div');
                    checkboxDiv.className = 'form-check';
                    checkboxDiv.innerHTML = `
                        <input class="form-check-input" type="checkbox" id="service_${service.id}" value="${service.id}" ${isChecked ? 'checked' : ''}>
                        <label class="form-check-label" for="service_${service.id}">
                            <strong>${service.nome}</strong>
                            ${service.descricao ? `<br><small class="text-muted">${service.descricao}</small>` : ''}
                            <br><small class="text-muted">Duração: ${service.duracao_minutos || 60}min | Preço: ${Formatter.currency(service.preco)}</small>
                        </label>
                    `;

                    checkboxesContainer.appendChild(checkboxDiv);
                });

                // Mostrar seção de serviços
                document.getElementById('servicesAssociation').style.display = 'block';

                // Resetar botão "Marcar Todos"
                const selectAllBtn = document.getElementById('selectAllServices');
                if (selectAllBtn) {
                    selectAllBtn.textContent = 'Marcar Todos';
                }

                console.log('[PROFESSIONAL-SELECT] Checkboxes gerados com sucesso');

            } catch (error) {
                console.error('[PROFESSIONAL-SELECT] Erro ao carregar serviços:', error);
                UI.showError('Erro ao carregar serviços para associação.');
            }
        }

        // Salvar associações de serviços
        async function handleSaveServiceAssociation() {
            const professionalSelect = document.getElementById('professionalSelect');
            const professionalId = professionalSelect.value;

            if (!professionalId) {
                UI.showError('Selecione um profissional primeiro.');
                return;
            }

            try {
                // Coletar serviços selecionados
                const selectedServices = [];
                const checkboxes = document.querySelectorAll('#servicesCheckboxes input[type="checkbox"]:checked');

                checkboxes.forEach(checkbox => {
                    selectedServices.push(parseInt(checkbox.value));
                });

                console.log(`[SAVE-ASSOCIATION] Salvando ${selectedServices.length} associações para profissional ${professionalId}`);

                // Enviar para API
                const result = await api.request(`/professionals/${professionalId}/services`, {
                    method: 'POST',
                    body: JSON.stringify(selectedServices)
                });

                if (result.success) {
                    UI.showSuccess(result.message || 'Associações salvas com sucesso!');
                    console.log('[SAVE-ASSOCIATION] Associações salvas com sucesso');
                } else {
                    UI.showError(result.message || 'Erro ao salvar associações.');
                }

            } catch (error) {
                console.error('[SAVE-ASSOCIATION] Erro ao salvar associações:', error);
                UI.showError('Erro ao salvar associações de serviços.');
            }
        }

        // Cancelar associação de serviços
        function handleCancelServiceAssociation() {
            // Limpar seleção
            document.getElementById('professionalSelect').value = '';
            document.getElementById('servicesAssociation').style.display = 'none';
            document.getElementById('servicesCheckboxes').innerHTML = '';

            console.log('[CANCEL-ASSOCIATION] Associação cancelada');
        }

        // Marcar/desmarcar todos os serviços
        function handleSelectAllServices() {
            console.log('[SELECT-ALL] Botão clicado');

            const checkboxes = document.querySelectorAll('#servicesCheckboxes input[type="checkbox"]');
            const selectAllBtn = document.getElementById('selectAllServices');

            console.log(`[SELECT-ALL] Encontrados ${checkboxes.length} checkboxes`);

            if (!checkboxes.length) {
                console.log('[SELECT-ALL] Nenhum checkbox encontrado');
                return;
            }

            // Verificar se todos estão marcados
            const allChecked = Array.from(checkboxes).every(cb => cb.checked);
            console.log(`[SELECT-ALL] Todos marcados: ${allChecked}`);

            // Se todos estão marcados, desmarcar todos; senão, marcar todos
            const newState = !allChecked;
            console.log(`[SELECT-ALL] Novo estado: ${newState}`);

            checkboxes.forEach((checkbox, index) => {
                console.log(`[SELECT-ALL] Checkbox ${index}: ${checkbox.id} - estado atual: ${checkbox.checked} -> ${newState}`);
                checkbox.checked = newState;
            });

            // Atualizar texto do botão
            selectAllBtn.textContent = newState ? 'Desmarcar Todos' : 'Marcar Todos';

            console.log(`[SELECT-ALL] ${newState ? 'Marcados' : 'Desmarcados'} todos os serviços`);
        }

        // ============ INFORMAÇÕES BÁSICAS ============

        // Carregar informações básicas da empresa
        async function loadCompanyBasic() {
            try {
                console.log('[COMPANY-BASIC] Carregando informações básicas...');

                const userInfo = await api.request('/auth/me');
                const companyId = userInfo.id;
                const companyData = await api.request(`/salons/${companyId}`);

                // Preencher formulário
                const companyNameField = document.getElementById('companyName');
                const companyPhoneField = document.getElementById('companyPhone');
                const companyStreetField = document.getElementById('companyStreet');
                const companyNeighborhoodField = document.getElementById('companyNeighborhood');
                const companyDescriptionField = document.getElementById('companyDescription');

                if (companyNameField) companyNameField.value = companyData.nome || '';
                if (companyPhoneField) companyPhoneField.value = companyData.telefone || '';

                // Quebrar endereço em rua e bairro
                const endereco = companyData.endereco || '';
                const enderecoParts = parseEndereco(endereco);
                if (companyStreetField) companyStreetField.value = enderecoParts.rua || '';
                if (companyNeighborhoodField) companyNeighborhoodField.value = enderecoParts.bairro || '';

                if (companyDescriptionField) companyDescriptionField.value = companyData.descricao || '';

                // Auto-preencher localização no card quando carregar
                updateCardLocationFromBasic();

                showCompanyProfileMessage('Dados básicos carregados com sucesso!', 'success');

            } catch (error) {
                console.error('[COMPANY-BASIC] Erro ao carregar:', error);
                showCompanyProfileMessage('Erro ao carregar dados básicos.', 'error');
            }
        }

        // Salvar informações básicas
        async function handleCompanyBasicSubmit(event) {
            event.preventDefault();

            try {
                console.log('[COMPANY-BASIC] Salvando informações básicas...');

                const userInfo = await api.request('/auth/me');
                console.log('[COMPANY-BASIC] userInfo:', userInfo);
                const companyId = userInfo.id;
                console.log('[COMPANY-BASIC] companyId:', companyId);

                // Reconstruir endereço completo
                const companyNameField = document.getElementById('companyName');
                const companyPhoneField = document.getElementById('companyPhone');
                const companyStreetField = document.getElementById('companyStreet');
                const companyNeighborhoodField = document.getElementById('companyNeighborhood');
                const companyDescriptionField = document.getElementById('companyDescription');

                const rua = companyStreetField ? companyStreetField.value.trim() : '';
                const bairro = companyNeighborhoodField ? companyNeighborhoodField.value.trim() : '';
                const enderecoCompleto = buildEndereco(rua, bairro);

                const companyData = {
                    nome: companyNameField ? companyNameField.value.trim() : '',
                    telefone: companyPhoneField ? companyPhoneField.value.trim() : '',
                    endereco: enderecoCompleto,
                    descricao: companyDescriptionField ? companyDescriptionField.value.trim() : ''
                };
                console.log('[COMPANY-BASIC] Dados a serem enviados:', companyData);

                if (!companyData.nome) {
                    showCompanyProfileMessage('Nome da empresa é obrigatório.', 'error');
                    return;
                }

                console.log('[COMPANY-BASIC] Fazendo requisição PUT para:', `/salons/${companyId}`);
                const result = await api.request(`/salons/${companyId}`, {
                    method: 'PUT',
                    body: JSON.stringify(companyData)
                });
                console.log('[COMPANY-BASIC] Resposta da API:', result);

                // Recarregar dados do formulário após salvar
                console.log('[COMPANY-BASIC] Recarregando dados do formulário...');
                await loadCompanyBasic();

                // Atualizar navbar em tempo real
                await loadNavbarInfo();

                showCompanyProfileMessage('Informações básicas salvas com sucesso!', 'success');

            } catch (error) {
                console.error('[COMPANY-BASIC] Erro ao salvar:', error);
                console.error('[COMPANY-BASIC] Detalhes do erro:', {
                    message: error.message,
                    stack: error.stack,
                    name: error.name
                });
                showCompanyProfileMessage('Erro ao salvar informações básicas.', 'error');
            }
        }

        // ============ APARÊNCIA DO CARD ============

        // Carregar aparência do card
        async function loadCompanyAppearance() {
            try {
                console.log('[COMPANY-APPEARANCE] Carregando aparência...');

                const userInfo = await api.request('/auth/me');
                const companyId = userInfo.id;
                const companyData = await api.request(`/salons/${companyId}`);

                // Auto-preencher nome no card com nome da empresa
                const nomeEmpresa = companyData.nome || '';
                document.getElementById('cardDisplayName').value = companyData.card_display_name || nomeEmpresa;

                // Localização vem do bairro definido nas informações básicas
                updateCardLocationFromBasic();

                // Descrição do card (limitada a 150 caracteres da descrição completa)
                const descricaoCompleta = companyData.descricao || '';
                const descricaoCard = companyData.card_description || descricaoCompleta.substring(0, 150);
                document.getElementById('cardDescription').value = descricaoCard;

                // Logo do card (se existir, senão usa o logo geral)
                const cardLogo = companyData.card_logo || companyData.logo;
                if (cardLogo) {
                    document.getElementById('logoImage').src = cardLogo;
                    document.getElementById('logoPreview').style.display = 'block';
                    // Armazenar URL do logo existente
                    window.uploadedLogoUrl = cardLogo;
                    console.log('[COMPANY-APPEARANCE] Logo existente carregado:', cardLogo);
                } else {
                    // Limpar se não há logo
                    window.uploadedLogoUrl = null;
                    document.getElementById('logoPreview').style.display = 'none';
                }

                // Atualizar preview
                updateCardPreview({
                    nome: document.getElementById('cardDisplayName').value,
                    endereco: document.getElementById('cardLocation').value,
                    descricao: document.getElementById('cardDescription').value,
                    logo: cardLogo
                });

                showCompanyProfileMessage('Aparência carregada com sucesso!', 'success');

            } catch (error) {
                console.error('[COMPANY-APPEARANCE] Erro ao carregar:', error);
                showCompanyProfileMessage('Erro ao carregar aparência.', 'error');
            }
        }

        // Salvar aparência do card
        async function handleCompanyAppearanceSubmit(event) {
            event.preventDefault();

            try {
                console.log('[COMPANY-APPEARANCE] Salvando aparência...');

                const userInfo = await api.request('/auth/me');
                const companyId = userInfo.id;

                const appearanceData = {
                    cardDisplayName: document.getElementById('cardDisplayName').value.trim(),
                    cardLocation: document.getElementById('cardLocation').value.trim(),
                    cardDescription: document.getElementById('cardDescription').value.trim()
                };

                // Incluir cardLogo se foi feito upload
                if (window.uploadedLogoUrl) {
                    appearanceData.cardLogo = window.uploadedLogoUrl;
                    console.log('[COMPANY-APPEARANCE] Incluindo cardLogo:', window.uploadedLogoUrl);
                } else {
                    // Se não há logo específico, usar o logo geral como cardLogo
                    const companyLogo = document.getElementById('logoImage').src;
                    if (companyLogo && companyLogo !== '' && !companyLogo.includes('placeholder')) {
                        appearanceData.cardLogo = companyLogo;
                        console.log('[COMPANY-APPEARANCE] Usando logo geral como cardLogo:', companyLogo);
                    }
                }

                if (!appearanceData.cardDisplayName) {
                    showCompanyProfileMessage('Nome no card é obrigatório.', 'error');
                    return;
                }

                console.log('[COMPANY-APPEARANCE] Dados a serem enviados:', appearanceData);

                const result = await api.request(`/salons/${companyId}/appearance`, {
                    method: 'PUT',
                    body: JSON.stringify(appearanceData)
                });

                console.log('[COMPANY-APPEARANCE] Aparência salva:', result);

                // Recarregar dados do formulário após salvar
                console.log('[COMPANY-APPEARANCE] Recarregando dados do formulário...');
                await loadCompanyAppearance();

                // Atualizar preview
                updateCardPreview(appearanceData);

                // Atualizar navbar em tempo real
                await loadNavbarInfo();

                showCompanyProfileMessage('Aparência salva com sucesso!', 'success');

            } catch (error) {
                console.error('[COMPANY-APPEARANCE] Erro ao salvar:', error);
                showCompanyProfileMessage('Erro ao salvar aparência.', 'error');
            }
        }

        // Preview do logo
        function handleLogoPreview(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('logoImage').src = e.target.result;
                    document.getElementById('logoPreview').style.display = 'block';
                    document.getElementById('uploadLogo').disabled = false;
                };
                reader.readAsDataURL(file);
            }
        }

        // Upload do logo
        async function handleLogoUpload(event) {
            event.preventDefault();

            const fileInput = document.getElementById('companyLogo');
            const file = fileInput.files[0];

            if (!file) {
                UI.showError('Por favor, selecione um arquivo de logo primeiro.');
                return;
            }

            try {
                console.log('[LOGO_UPLOAD] Iniciando upload do logo...');

                // Criar FormData para envio do arquivo
                const formData = new FormData();
                formData.append('file', file);

                // Obter ID do salão
                const userInfo = await api.request('/auth/me');
                const salonId = userInfo.id;

                console.log('[LOGO_UPLOAD] Fazendo upload para salão:', salonId);

                // Fazer upload usando endpoint específico
                const response = await fetch(`${API_CONFIG.BASE_URL}/salons/${salonId}/upload-logo`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${TokenManager.get()}`
                    },
                    body: formData
                });

                if (response.ok) {
                    const result = await response.json();
                    console.log('[LOGO_UPLOAD] Upload bem-sucedido:', result);

                    // Atualizar preview com URL do servidor
                    document.getElementById('logoImage').src = result.logo_url;
                    document.getElementById('logoPreview').style.display = 'block';

                    // Armazenar URL do logo para uso posterior
                    window.uploadedLogoUrl = result.logo_url;

                    UI.showSuccess('Logo atualizado com sucesso!');

                    // Feedback visual no botão
                    const uploadBtn = document.getElementById('uploadLogo');
                    const originalText = uploadBtn.textContent;
                    uploadBtn.textContent = '✅ Enviado!';
                    uploadBtn.disabled = true;

                    setTimeout(() => {
                        uploadBtn.textContent = originalText;
                        uploadBtn.disabled = false;
                    }, 2000);

                } else {
                    const errorData = await response.json().catch(() => ({}));
                    console.error('[LOGO_UPLOAD] Erro no upload:', errorData);
                    UI.showError(errorData.detail || 'Erro ao fazer upload do logo.');
                }

            } catch (error) {
                console.error('[LOGO_UPLOAD] Erro:', error);
                UI.showError('Erro ao fazer upload do logo. Verifique sua conexão.');
            }
        }

        // ============ INFORMAÇÕES DO DONO ============

        // Carregar informações do dono
        async function loadCompanyOwner() {
            try {
                console.log('[COMPANY-OWNER] Carregando informações do dono...');

                // Carregar dados do perfil do usuário
                const userInfo = await api.request('/auth/me');

                // Carregar dados da empresa para replicar telefone
                const companyId = userInfo.id;
                const companyData = await api.request(`/salons/${companyId}`);

                // Preencher com dados do perfil
                document.getElementById('ownerName').value = userInfo.name || '';
                document.getElementById('ownerEmail').value = userInfo.email || '';

                // Replicar telefone da empresa
                document.getElementById('ownerPersonalPhone').value = companyData.telefone || '';

                showCompanyProfileMessage('Informações do dono carregadas!', 'success');

            } catch (error) {
                console.error('[COMPANY-OWNER] Erro ao carregar:', error);
                showCompanyProfileMessage('Erro ao carregar informações do dono.', 'error');
            }
        }

        // Salvar informações do dono
        async function handleCompanyOwnerSubmit(event) {
            event.preventDefault();

            try {
                console.log('[COMPANY-OWNER] Salvando informações do dono...');

                const userInfo = await api.request('/auth/me');
                const companyId = userInfo.id;

                const ownerData = {
                    // Por enquanto, salvamos as informações do dono na tabela de usuários
                    // Futuramente pode ser implementada uma tabela separada para informações do dono
                    name: document.getElementById('ownerName').value.trim(),
                    email: document.getElementById('ownerEmail').value.trim(),
                    telefone: document.getElementById('ownerPersonalPhone').value.trim(),
                    experiencia: document.getElementById('ownerExperience').value.trim()
                };

                // Validar dados obrigatórios
                if (!ownerData.name) {
                    showCompanyProfileMessage('Nome do dono é obrigatório.', 'error');
                    return;
                }

                // Atualizar informações do usuário (dono)
                const result = await api.request('/auth/update-profile', {
                    method: 'PUT',
                    body: JSON.stringify(ownerData)
                });

                console.log('[COMPANY-OWNER] Informações do dono salvas:', result);

                // Recarregar dados do formulário após salvar
                console.log('[COMPANY-OWNER] Recarregando dados do formulário...');
                await loadCompanyOwner();

                // Atualizar navbar em tempo real
                await loadNavbarInfo();

                showCompanyProfileMessage('Informações do dono salvas com sucesso!', 'success');

            } catch (error) {
                console.error('[COMPANY-OWNER] Erro ao salvar:', error);
                showCompanyProfileMessage('Erro ao salvar informações do dono.', 'error');
            }
        }

        // ============ COMPARTILHAMENTO ============

        // Carregar informações de compartilhamento
        async function loadCompanySharing() {
            try {
                console.log('[COMPANY-SHARING] Carregando compartilhamento...');

                const userInfo = await api.request('/auth/me');
                const companyId = userInfo.id;

                generateShareLink(companyId);
                showCompanyProfileMessage('Link de compartilhamento gerado!', 'success');

            } catch (error) {
                console.error('[COMPANY-SHARING] Erro ao carregar:', error);
                showCompanyProfileMessage('Erro ao gerar link de compartilhamento.', 'error');
            }
        }



        // Mostrar mensagens para o perfil da empresa
        function showCompanyProfileMessage(message, type) {
            const messages = document.getElementById('companyProfileMessages');

            if (!messages) {
                console.warn('Container de mensagens da empresa não encontrado');
                return;
            }

            const alertClass = type === 'error' ? 'alert-error' :
                              type === 'success' ? 'alert-success' :
                              type === 'warning' ? 'alert-warning' : 'alert-info';

            messages.innerHTML = `
                <div class="alert ${alertClass}" style="margin-top: 1rem;">
                    ${message}
                </div>
            `;

            // Auto-remove success messages after 5 seconds
            if (type === 'success') {
                setTimeout(() => {
                    if (messages) {
                        messages.innerHTML = '';
                    }
                }, 5000);
            }
        }

        // ============ FUNÇÕES AUXILIARES ============

        // Extrair localização do endereço
        function extractLocation(address) {
            if (!address) return '';
            // Tentar extrair bairro/cidade do endereço
            const parts = address.split(',');
            return parts.length > 1 ? parts[1].trim() : address;
        }

        // Atualizar preview do card
        function updateCardPreview(data) {
            const previewContainer = document.getElementById('cardPreview');

            const previewHtml = `
                <div class="salon-card">
                    <div class="salon-card-header">
                        ${data.logo ? `<img src="${data.logo}" alt="Logo" class="salon-logo">` : '<div class="salon-logo-placeholder">📷</div>'}
                        <div class="salon-info">
                            <h3 class="salon-name">${data.nome || 'Nome do Salão'}</h3>
                            <p class="salon-location">📍 ${data.endereco || 'Localização'}</p>
                        </div>
                    </div>
                    <div class="salon-card-body">
                        ${data.descricao ? `<p class="salon-description">${data.descricao}</p>` : ''}
                        <div class="salon-owner">
                            <small>👤 Dono: ${data.dono || 'Nome do Dono'}</small>
                        </div>
                    </div>
                    <div class="salon-card-footer">
                        <button class="btn btn-primary" disabled>Agendar Serviço</button>
                    </div>
                </div>
            `;

            previewContainer.innerHTML = previewHtml;
            console.log('[COMPANY] Preview do card atualizado');
        }

        // Gerar link de compartilhamento
        function generateShareLink(companyId) {
            const baseUrl = window.location.origin;
            const shareLink = `${baseUrl}/salon-selection.html?salon=${companyId}`;

            document.getElementById('companyShareLink').value = shareLink;
            console.log('[COMPANY] Link de compartilhamento gerado:', shareLink);
        }

        // Quebrar endereço em rua e bairro
        function parseEndereco(enderecoCompleto) {
            if (!enderecoCompleto) return { rua: '', bairro: '' };

            // Tentar identificar padrão: "Rua X, 123 - Bairro Y"
            const parts = enderecoCompleto.split(' - ');
            if (parts.length >= 2) {
                return {
                    rua: parts[0].trim(),
                    bairro: parts.slice(1).join(' - ').trim()
                };
            }

            // Fallback: assumir que tudo é rua
            return {
                rua: enderecoCompleto.trim(),
                bairro: ''
            };
        }

        // Construir endereço completo a partir de rua e bairro
        function buildEndereco(rua, bairro) {
            if (!rua && !bairro) return '';
            if (!rua) return bairro;
            if (!bairro) return rua;
            return `${rua} - ${bairro}`;
        }

        // Atualizar localização no card baseada nas informações básicas
        function updateCardLocationFromBasic() {
            const bairro = document.getElementById('companyNeighborhood').value.trim();
            document.getElementById('cardLocation').value = bairro;
        }

        // Atualizar nome no card baseado no nome da empresa
        function updateCardNameFromBasic() {
            const nomeEmpresa = document.getElementById('companyName').value.trim();
            const cardNameField = document.getElementById('cardDisplayName');

            // Só atualizar se o campo do card estiver vazio ou for igual ao nome anterior
            if (!cardNameField.value.trim() || cardNameField.dataset.autoFilled) {
                cardNameField.value = nomeEmpresa;
                cardNameField.dataset.autoFilled = 'true';
            }
        }

        // Atualizar telefone do dono baseado no telefone da empresa
        function updateOwnerPhoneFromBasic() {
            const telefoneEmpresa = document.getElementById('companyPhone').value.trim();
            document.getElementById('ownerPersonalPhone').value = telefoneEmpresa;
        }

        // Atualizar descrição do card baseada na descrição completa (limitada a 150 caracteres)
        function updateCardDescriptionFromBasic() {
            const descricaoCompleta = document.getElementById('companyDescription').value.trim();
            const cardDescriptionField = document.getElementById('cardDescription');

            // Só atualizar se o campo do card estiver vazio ou for baseado na descrição completa
            if (!cardDescriptionField.value.trim() || cardDescriptionField.dataset.autoFilled) {
                const descricaoLimitada = descricaoCompleta.substring(0, 150);
                cardDescriptionField.value = descricaoLimitada;
                cardDescriptionField.dataset.autoFilled = 'true';
            }
        }

        // Copiar link para área de transferência
        async function copyShareLink() {
            const linkInput = document.getElementById('companyShareLink');
            const link = linkInput.value;

            if (!link) {
                showCompanyProfileMessage('Link não disponível para copiar.', 'warning');
                return;
            }

            try {
                await navigator.clipboard.writeText(link);
                showCompanyProfileMessage('Link copiado para a área de transferência!', 'success');

                // Feedback visual no botão
                const copyBtn = document.getElementById('copyShareLink');
                const originalText = copyBtn.textContent;
                copyBtn.textContent = '✅ Copiado!';
                copyBtn.classList.add('btn-success');

                setTimeout(() => {
                    copyBtn.textContent = originalText;
                    copyBtn.classList.remove('btn-success');
                }, 2000);

            } catch (error) {
                console.error('[COMPANY] Erro ao copiar link:', error);
                showCompanyProfileMessage('Erro ao copiar link. Copie manualmente.', 'error');
            }
        }

        // Mostrar mensagens para o perfil da empresa
        function showCompanyProfileMessage(message, type) {
            const messages = document.getElementById('companyProfileMessages');

            if (!messages) {
                console.warn('Container de mensagens da empresa não encontrado');
                return;
            }

            const alertClass = type === 'error' ? 'alert-error' :
                              type === 'success' ? 'alert-success' :
                              type === 'warning' ? 'alert-warning' : 'alert-info';

            messages.innerHTML = `
                <div class="alert ${alertClass}" style="margin-top: 1rem;">
                    ${message}
                </div>
            `;

            // Auto-remove success messages after 5 seconds
            if (type === 'success') {
                setTimeout(() => {
                    if (messages) {
                        messages.innerHTML = '';
                    }
                }, 5000);
            }
        }

        // ============ UTILITÁRIOS ============

        // Converter kebab-case para camelCase
        function kebabToCamel(str) {
            return str.replace(/-([a-z])/g, function(match, letter) {
                return letter.toUpperCase();
            });
        }

        // ============ SISTEMA DE GERENCIAMENTO DE HORÁRIOS ============

        // Carregar horários atuais
        async function loadCurrentHours() {
            console.log('Função loadCurrentHours() chamada');

            // Verificar se o container da aba de horários existe e está visível
            const businessHoursTab = document.getElementById('businessHoursTab');
            if (!businessHoursTab) {
                console.error('Container da aba de horários não encontrado');
                showBusinessHoursMessage('Erro: Container da aba de horários não encontrado na página.', 'error');
                return;
            }

            // Garantir que a aba está ativa/visível
            if (businessHoursTab.style.display === 'none' || !businessHoursTab.classList.contains('active')) {
                console.log('Ativando aba de horários');
                businessHoursTab.style.display = 'block';
                businessHoursTab.classList.add('active');
            }

            const businessHoursForm = document.getElementById('businessHoursForm');
            if (!businessHoursForm) {
                console.error('Formulário de horários não encontrado');
                showBusinessHoursMessage('Erro: Formulário de horários não encontrado na página.', 'error');
                return;
            }

            try {
                // Mostrar loader
                showBusinessHoursLoader(true);

                // Obter empresa ID do token JWT
                const token = TokenManager.get();
                if (!token) {
                    showBusinessHoursMessage('Token de autenticação não encontrado. Faça login novamente.', 'error');
                    return;
                }

                console.log('Token JWT encontrado:', token.substring(0, 50) + '...');

                let empresaId;
                try {
                    // Decodificar token JWT para obter empresa ID
                    const payload = JSON.parse(atob(token.split('.')[1]));
                    empresaId = payload.sub || payload.user_id || payload.id;

                    console.log('Payload do token:', payload);
                    console.log('Empresa ID obtido:', empresaId);

                    if (!empresaId) {
                        throw new Error('Empresa ID não encontrado no token');
                    }
                } catch (error) {
                    console.error('Erro ao decodificar token JWT:', error);
                    showBusinessHoursMessage('Erro na autenticação. Faça login novamente.', 'error');
                    return;
                }

                console.log('Fazendo requisição para:', `${API_CONFIG.BASE_URL}/empresa/${empresaId}/horarios`);

                const response = await fetch(`${API_CONFIG.BASE_URL}/empresa/${empresaId}/horarios`, {
                    headers: {
                        'Authorization': `Bearer ${TokenManager.get()}`,
                        'Content-Type': 'application/json'
                    }
                });

                console.log('Status da resposta:', response.status);
                console.log('Headers da resposta:', Object.fromEntries(response.headers.entries()));

                if (response.ok) {
                    const data = await response.json();
                    console.log('Dados recebidos:', data);

                    // Verificar se há dados válidos
                    if (data && typeof data === 'object') {
                        console.log('Dados recebidos para renderização:', data);

                        // Verificar se não há dados além do empresa_id
                        const dataKeys = Object.keys(data).filter(key => key !== 'empresa_id');
                        if (dataKeys.length === 0) {
                            console.log('Nenhum horário cadastrado ainda');
                            clearBusinessHoursForm();
                            showBusinessHoursMessage('Nenhum horário cadastrado. Configure os horários de funcionamento.', 'info');
                            return;
                        }

                        // Preencher campos com dados atuais - verificar se elementos existem
                        const dias = ['segunda', 'terca', 'quarta', 'quinta', 'sexta', 'sabado'];

                        dias.forEach(dia => {
                            const aberturaInput = document.getElementById(`${dia}_abertura`);
                            const fechamentoInput = document.getElementById(`${dia}_fechamento`);

                            if (aberturaInput && data[dia]?.abertura) {
                                aberturaInput.value = data[dia].abertura;
                                console.log(`Campo ${dia}_abertura preenchido com:`, data[dia].abertura);
                            } else if (aberturaInput) {
                                aberturaInput.value = ''; // Deixar vazio se não houver horário
                                console.log(`Campo ${dia}_abertura deixado vazio`);
                            } else {
                                console.warn(`Input ${dia}_abertura não encontrado no DOM`);
                            }

                            if (fechamentoInput && data[dia]?.fechamento) {
                                fechamentoInput.value = data[dia].fechamento;
                                console.log(`Campo ${dia}_fechamento preenchido com:`, data[dia].fechamento);
                            } else if (fechamentoInput) {
                                fechamentoInput.value = ''; // Deixar vazio se não houver horário
                                console.log(`Campo ${dia}_fechamento deixado vazio`);
                            } else {
                                console.warn(`Input ${dia}_fechamento não encontrado no DOM`);
                            }
                        });

                        // Domingo - verificar se elementos existem
                        const domingoFechado = document.getElementById('domingo_fechado');
                        const domingoAbertura = document.getElementById('domingo_abertura');
                        const domingoFechamento = document.getElementById('domingo_fechamento');

                        if (domingoFechado && domingoAbertura && domingoFechamento) {
                            if (data.domingo?.abertura && data.domingo?.fechamento) {
                                domingoFechado.checked = false;
                                domingoAbertura.value = data.domingo.abertura;
                                domingoFechamento.value = data.domingo.fechamento;
                                toggleDomingo();
                                console.log('Domingo preenchido com horários');
                            } else {
                                domingoFechado.checked = true;
                                domingoAbertura.value = '';
                                domingoFechamento.value = '';
                                toggleDomingo();
                                console.log('Domingo marcado como fechado');
                            }
                        } else {
                            console.warn('Elementos do domingo não encontrados no DOM');
                        }

                        showBusinessHoursMessage('Horários carregados com sucesso!', 'success');
                    } else {
                        // Se não há dados, deixar campos vazios
                        console.log('Dados inválidos ou vazios recebidos');
                        clearBusinessHoursForm();
                        showBusinessHoursMessage('Nenhum horário cadastrado. Configure os horários de funcionamento.', 'info');
                    }
                } else if (response.status === 404) {
                    // Empresa não tem horários cadastrados
                    clearBusinessHoursForm();
                    showBusinessHoursMessage('Nenhum horário cadastrado. Configure os horários de funcionamento.', 'info');
                } else {
                    const errorText = await response.text();
                    console.error('Erro na resposta:', errorText);
                    let errorData;
                    try {
                        errorData = JSON.parse(errorText);
                    } catch (e) {
                        errorData = { detail: errorText };
                    }
                    showBusinessHoursMessage(errorData.detail || `Erro ao carregar horários atuais (${response.status}).`, 'error');
                }

            } catch (error) {
                console.error('Erro ao carregar horários:', error);
                showBusinessHoursMessage('Erro ao carregar horários. Verifique sua conexão.', 'error');
            } finally {
                // Esconder loader
                showBusinessHoursLoader(false);
            }
        }

        // Limpar formulário de horários
        function clearBusinessHoursForm() {
            const dias = ['segunda', 'terca', 'quarta', 'quinta', 'sexta', 'sabado'];

            dias.forEach(dia => {
                const aberturaInput = document.getElementById(`${dia}_abertura`);
                const fechamentoInput = document.getElementById(`${dia}_fechamento`);

                if (aberturaInput) aberturaInput.value = '';
                if (fechamentoInput) fechamentoInput.value = '';
            });

            // Domingo
            const domingoFechado = document.getElementById('domingo_fechado');
            const domingoAbertura = document.getElementById('domingo_abertura');
            const domingoFechamento = document.getElementById('domingo_fechamento');

            if (domingoFechado) domingoFechado.checked = true;
            if (domingoAbertura) domingoAbertura.value = '';
            if (domingoFechamento) domingoFechamento.value = '';
            toggleDomingo();
        }

        // Mostrar/esconder loader
        function showBusinessHoursLoader(show) {
            const form = document.getElementById('businessHoursForm');
            if (!form) return;

            if (show) {
                form.style.opacity = '0.6';
                form.style.pointerEvents = 'none';

                // Adicionar loader se não existir
                let loader = form.querySelector('.business-hours-loader');
                if (!loader) {
                    loader = document.createElement('div');
                    loader.className = 'business-hours-loader';
                    loader.innerHTML = '<div class="loading">Carregando horários...</div>';
                    loader.style.cssText = `
                        position: absolute;
                        top: 50%;
                        left: 50%;
                        transform: translate(-50%, -50%);
                        background: white;
                        padding: 1rem;
                        border-radius: 0.25rem;
                        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
                        z-index: 1000;
                    `;
                    form.style.position = 'relative';
                    form.appendChild(loader);
                }
            } else {
                form.style.opacity = '1';
                form.style.pointerEvents = 'auto';

                const loader = form.querySelector('.business-hours-loader');
                if (loader) {
                    loader.remove();
                }
            }
        }

        // Toggle para mostrar/ocultar horários do domingo
        function toggleDomingo() {
            const domingoFechado = document.getElementById('domingo_fechado');
            const hoursDiv = document.getElementById('domingo_hours');

            if (!domingoFechado || !hoursDiv) {
                console.warn('Elementos do domingo não encontrados');
                return;
            }

            const fechado = domingoFechado.checked;
            hoursDiv.style.display = fechado ? 'none' : 'grid';
        }

        // Processar submit do formulário de horários
        async function handleBusinessHoursSubmit(event) {
            event.preventDefault();

            // Verificar se o formulário existe
            const form = document.getElementById('businessHoursForm');
            if (!form) {
                console.error('Formulário de horários não encontrado');
                return;
            }

            // Coletar dados do formulário - verificar se elementos existem
            const formData = [];
            const dias = ['segunda', 'terca', 'quarta', 'quinta', 'sexta', 'sabado'];

            dias.forEach(dia => {
                const aberturaInput = document.getElementById(`${dia}_abertura`);
                const fechamentoInput = document.getElementById(`${dia}_fechamento`);

                if (aberturaInput && fechamentoInput) {
                    formData.push({
                        dia: dia,
                        abertura: aberturaInput.value,
                        fechamento: fechamentoInput.value
                    });
                }
            });

            // Domingo - verificar se elementos existem
            const domingoFechado = document.getElementById('domingo_fechado');
            const domingoAbertura = document.getElementById('domingo_abertura');
            const domingoFechamento = document.getElementById('domingo_fechamento');

            if (domingoFechado && domingoAbertura && domingoFechamento) {
                if (!domingoFechado.checked) {
                    formData.push({
                        dia: 'domingo',
                        abertura: domingoAbertura.value,
                        fechamento: domingoFechamento.value
                    });
                }
            }

            // Validar dados
            if (!validateBusinessHoursData(formData)) {
                return;
            }

            try {
                // Mostrar loader
                showBusinessHoursLoader(true);

                // Obter empresa ID do token JWT usando TokenManager
                const token = TokenManager.get();
                if (!token) {
                    showBusinessHoursMessage('Token de autenticação não encontrado. Faça login novamente.', 'error');
                    return;
                }

                let empresaId;
                try {
                    // Decodificar token JWT para obter empresa ID
                    const payload = JSON.parse(atob(token.split('.')[1]));
                    empresaId = payload.sub || payload.user_id || payload.id;

                    if (!empresaId) {
                        throw new Error('Empresa ID não encontrado no token');
                    }
                } catch (error) {
                    console.error('Erro ao decodificar token JWT:', error);
                    showBusinessHoursMessage('Erro na autenticação. Faça login novamente.', 'error');
                    return;
                }

                const response = await fetch(`${API_CONFIG.BASE_URL}/empresa/${empresaId}/horarios`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${TokenManager.get()}`
                    },
                    body: JSON.stringify(formData)
                });

                if (response.ok) {
                    const result = await response.json();
                    showBusinessHoursMessage('Horários salvos com sucesso!', 'success');
                } else {
                    const errorData = await response.json().catch(() => ({}));
                    showBusinessHoursMessage(errorData.detail || 'Erro ao salvar horários.', 'error');
                }

            } catch (error) {
                console.error('Erro ao salvar horários:', error);
                showBusinessHoursMessage('Erro ao salvar horários. Verifique sua conexão.', 'error');
            } finally {
                // Esconder loader
                showBusinessHoursLoader(false);
            }
        }

        // Validar dados dos horários
        function validateBusinessHoursData(data) {
            if (!Array.isArray(data)) {
                showBusinessHoursMessage('Dados inválidos para validação.', 'error');
                return false;
            }

            const dias = ['segunda', 'terca', 'quarta', 'quinta', 'sexta', 'sabado'];

            // Verificar se todos os dias da semana estão presentes
            const diasPresentes = data.map(item => item.dia);
            for (const dia of dias) {
                if (!diasPresentes.includes(dia)) {
                    showBusinessHoursMessage(`Dados incompletos para ${dia}.`, 'error');
                    return false;
                }
            }

            for (const item of data) {
                const dia = item.dia;
                const abertura = item.abertura;
                const fechamento = item.fechamento;

                // Validar formato HH:MM
                if (abertura && !isValidTimeFormat(abertura)) {
                    showBusinessHoursMessage(`Formato inválido para horário de abertura de ${dia}. Use HH:MM.`, 'error');
                    return false;
                }

                if (fechamento && !isValidTimeFormat(fechamento)) {
                    showBusinessHoursMessage(`Formato inválido para horário de fechamento de ${dia}. Use HH:MM.`, 'error');
                    return false;
                }

                // Se um horário está preenchido, o outro também deve estar
                if ((abertura && !fechamento) || (!abertura && fechamento)) {
                    showBusinessHoursMessage(`Preencha ambos os horários (abertura e fechamento) para ${dia}.`, 'error');
                    return false;
                }

                // Validar lógica: abertura deve ser antes do fechamento
                if (abertura && fechamento && abertura >= fechamento) {
                    showBusinessHoursMessage(`Horário de abertura deve ser anterior ao fechamento em ${dia}.`, 'error');
                    return false;
                }
            }

            return true;
        }

        // Validar formato de horário HH:MM
        function isValidTimeFormat(time) {
            if (!time || typeof time !== 'string') return false;

            const timeRegex = /^([0-1]?[0-9]|2[0-3]):[0-5][0-9]$/;
            return timeRegex.test(time);
        }

        // Mostrar mensagens para o sistema de horários
        function showBusinessHoursMessage(message, type) {
            const messages = document.getElementById('businessHoursMessages');

            if (!messages) {
                console.warn('Container de mensagens não encontrado');
                return;
            }

            const alertClass = type === 'error' ? 'alert-error' :
                               type === 'success' ? 'alert-success' : 'alert-info';

            messages.innerHTML = `
                <div class="alert ${alertClass}" style="margin-top: 1rem;">
                    ${message}
                </div>
            `;

            // Auto-remove success messages after 5 seconds
            if (type === 'success') {
                setTimeout(() => {
                    if (messages) {
                        messages.innerHTML = '';
                    }
                }, 5000);
            }
        }
    </script>

    <style>
        /* Navbar com informações */
        .nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 0;
        }

        .nav-info {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-left: auto;
            margin-right: 2rem;
            font-size: 0.9rem;
            color: #666;
        }

        .company-name {
            font-weight: 600;
            color: #333;
        }

        .owner-name {
            color: #666;
        }

        .separator {
            color: #ccc;
            font-weight: bold;
        }

        .nav-links {
            display: flex;
            gap: 1rem;
            margin: 0;
        }

        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .badge {
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            font-weight: 600;
        }
        .badge-success { background-color: var(--success-color); color: white; }
        .badge-warning { background-color: var(--warning-color); color: black; }
        .badge-danger { background-color: var(--error-color); color: white; }
        .badge-info { background-color: var(--info-color); color: white; }
        .badge-dark { background-color: #6c757d; color: white; }

        /* Sub-tabs styling */
        .sub-tab-content { display: none; }
        .sub-tab-content.active { display: block; }
        .sub-tab-btn { margin: 0; }

        /* Estilos para o sistema de gerenciamento de horários */
        .checkbox-group {
            margin-bottom: 1rem;
        }

        .checkbox-group input[type="checkbox"] {
            margin-right: 0.5rem;
        }

        .alert {
            padding: 1rem;
            border-radius: 0.25rem;
            margin-bottom: 1rem;
        }

        .alert-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .alert-info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        /* Estilos para o loader */
        .business-hours-loader {
            text-align: center;
            color: #666;
            font-style: italic;
        }

        .business-hours-loader .loading {
            display: inline-block;
            padding: 0.5rem 1rem;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 0.25rem;
            border: 1px solid #ddd;
        }

        /* Melhorar aparência dos inputs de horário */
        input[type="time"] {
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 0.25rem;
            font-size: 1rem;
        }

        input[type="time"]:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
        }

        /* Sistema de Notificações de Presença */
        .notifications-container {
            position: fixed;
            top: 80px;
            right: 20px;
            z-index: 1000;
            max-width: 400px;
        }

        .notification {
            background: white;
            border-radius: 0.5rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            border-left: 4px solid #ffc107;
            margin-bottom: 1rem;
            padding: 1rem;
            animation: slideInRight 0.3s ease-out;
        }

        .notification.attention {
            border-left-color: #dc3545;
            background: linear-gradient(135deg, #fff5f5 0%, #ffffff 100%);
        }

        .notification.success {
            border-left-color: #28a745;
            background: linear-gradient(135deg, #f8fff8 0%, #ffffff 100%);
        }

        .notification.warning {
            border-left-color: #ffc107;
            background: linear-gradient(135deg, #fffef8 0%, #ffffff 100%);
        }

        .notification-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .notification-title {
            font-weight: 600;
            color: #333;
            margin: 0;
        }

        .notification-time {
            font-size: 0.8rem;
            color: #666;
        }

        .notification-message {
            color: #555;
            margin-bottom: 0.75rem;
            line-height: 1.4;
        }

        .notification-actions {
            display: flex;
            gap: 0.5rem;
        }

        .notification-actions button {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 0.25rem;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .notification-actions .btn-success {
            background: #28a745;
            color: white;
        }

        .notification-actions .btn-success:hover {
            background: #218838;
        }

        .notification-actions .btn-danger {
            background: #dc3545;
            color: white;
        }

        .notification-actions .btn-danger:hover {
            background: #c82333;
        }

        .notification-countdown {
            font-size: 0.8rem;
            color: #dc3545;
            font-weight: 600;
            text-align: center;
            margin-top: 0.5rem;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Modal de presença */
        #presenceModal {
            z-index: 10000;
        }

        #presenceModal .modal-content {
            max-width: 500px;
        }

        /* Modal de detalhes do agendamento */
        #appointmentDetailsModal {
            z-index: 10001;
        }

        .appointment-details {
            max-height: 70vh;
            overflow-y: auto;
        }

        .detail-section {
            margin-bottom: 2rem;
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 0.5rem;
            border-left: 4px solid #007bff;
        }

        .detail-section h4 {
            margin: 0 0 1rem 0;
            color: #333;
            font-size: 1.1rem;
            font-weight: 600;
        }

        .detail-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 0.75rem;
        }

        .detail-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem;
            background: white;
            border-radius: 0.25rem;
            border: 1px solid #e9ecef;
        }

        .detail-item strong {
            color: #495057;
            font-weight: 600;
        }

        @media (min-width: 768px) {
            .detail-grid {
                grid-template-columns: 1fr 1fr;
            }
        }

        .presence-info {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
        }

        .presence-info h4 {
            margin: 0 0 0.5rem 0;
            color: #333;
        }

        .presence-info p {
            margin: 0.25rem 0;
            color: #666;
        }

        .presence-timer {
            text-align: center;
            font-size: 1.2rem;
            font-weight: 600;
            color: #dc3545;
            margin: 1rem 0;
        }

        /* Estilos para bloqueio de funcionalidades */
        .blocked-overlay {
            pointer-events: none;
        }

        .blocked-message {
            text-align: center;
            padding: 2rem;
            background: #f8f9fa;
            border: 2px dashed #dc3545;
            border-radius: 0.5rem;
        }

        .blocked-icon {
            font-size: 2rem;
            display: block;
            margin-bottom: 0.5rem;
        }

        .blocked-text {
            color: #dc3545;
            font-weight: 600;
            font-size: 1.1rem;
        }

        /* Ajustes para botões desabilitados */
        button:disabled {
            cursor: not-allowed;
            opacity: 0.5;
        }

        button:disabled:hover {
            transform: none;
            box-shadow: none;
        }

        /* Estilos para o perfil da empresa */
        .company-card-preview {
            border: 2px dashed #dee2e6;
            border-radius: 0.5rem;
            padding: 1rem;
            background: #f8f9fa;
        }

        .company-card-preview .salon-card {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 0.5rem;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            max-width: 300px;
            margin: 0 auto;
        }

        .company-card-preview .salon-card-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1rem;
        }

        .company-card-preview .salon-logo {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid white;
        }

        .company-card-preview .salon-logo-placeholder {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: rgba(255,255,255,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            border: 2px solid white;
        }

        .company-card-preview .salon-info h3 {
            margin: 0 0 0.25rem 0;
            font-size: 1.1rem;
            font-weight: 600;
        }

        .company-card-preview .salon-location {
            margin: 0;
            opacity: 0.9;
            font-size: 0.85rem;
        }

        .company-card-preview .salon-card-body {
            padding: 1rem;
        }

        .company-card-preview .salon-description {
            margin: 0.5rem 0;
            color: #495057;
            font-size: 0.9rem;
            line-height: 1.4;
        }

        .company-card-preview .salon-owner {
            margin-top: 0.75rem;
            padding-top: 0.75rem;
            border-top: 1px solid #e9ecef;
        }

        .company-card-preview .salon-owner small {
            color: #6c757d;
            font-weight: 500;
        }

        .company-card-preview .salon-card-footer {
            padding: 1rem;
            background: #f8f9fa;
            text-align: center;
        }

        .company-card-preview .salon-card-footer button {
            opacity: 0.7;
            cursor: not-allowed;
            width: 100%;
        }

        .company-card-preview .salon-card-footer button:hover {
            transform: none;
        }

        /* Sub-tabs styling */
        .sub-tab-content { display: none; }
        .sub-tab-content.active { display: block; }
        .sub-tab-btn { margin: 0; }

        /* Preview do logo */
        #logoPreview {
            margin-top: 1rem;
            text-align: center;
        }
    
        #logoImage {
            border: 1px solid #ddd;
            border-radius: 0.25rem;
        }
    
        /* Responsividade da logo */
        @media (max-width: 768px) {
            .logo-section img {
                height: 30px;
                max-width: 30px;
            }
        }
    
        @media (max-width: 480px) {
            .logo-section img {
                height: 25px;
                max-width: 25px;
            }
        }
    </style>
    <script>
        window.addEventListener('load', () => {
            const elements = document.querySelectorAll('.fade-in');
            elements.forEach((el, index) => {
                // Adiciona a classe com um pequeno atraso para cada elemento (opcional)
                setTimeout(() => {
                    el.classList.add('visible');
                }, index * 200); // 200ms de diferença entre cada elemento
            });
        });
    </script>
</body>

</html>
